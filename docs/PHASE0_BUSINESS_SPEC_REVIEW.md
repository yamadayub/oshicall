# Phase 0: 業務仕様確認レポート

## 業務仕様ファイル
- `/docs/business/video-call.md`: ✅ 存在する

## 関連するビジネスルール

### Issue #1（入室状態表示）に関連

**該当するルール**: 該当するルールが定義されていない

**現状の業務仕様**:
- BR-002: 通話アクセス制限 - 予定時刻の前後30分のみ通話可能
- BR-004: Talk完了判定 - インフルエンサー参加必須、規定時間経過必須、途中退出なし必須

**問題点**:
- 待機室（CallPage）での入室状態表示に関するルールが未定義
- 「待機中」と「未入室」の区別が明確でない
- 片方がCallPageに入った時の相手の表示状態が定義されていない

### Issue #2（15分前入室）に関連

**該当するルール**: 部分的に定義されている

**現状の業務仕様**:
- 制約事項（144-147行目）:
  - 通話可能時間は予定時刻の前後30分のみ
  - **インフルエンサーは開始時刻前（15分前から）に入室して待機可能**
  - Daily.co無料プランは通話時間に制限あり

**問題点**:
- インフルエンサーの15分前入室は「制約事項」として記載されているが、ビジネスルール（BR-xxx）として明確に定義されていない
- ファンの入室タイミングとの違いが明確でない
- Daily.coセッションへの入室可否の判定ロジックが定義されていない

## 業務仕様の更新要否

- [x] **更新必要（理由: ビジネスルールが未定義または不十分）**

### 更新が必要な理由

1. **Issue #1**: 入室状態表示に関するビジネスルールが未定義
   - 待機室での状態表示ルールが必要
   - 「待機中」と「未入室」の明確な定義が必要

2. **Issue #2**: インフルエンサーの15分前入室が制約事項としてのみ記載
   - ビジネスルール（BR-xxx）として明確に定義すべき
   - ファンとの入室タイミングの違いを明確化すべき

## 現状のコード調査

### CallPage関連ファイル
- `src/pages/CallPage.tsx` - 通話ページのメインコンポーネント
- `src/components/calls/CallWaitingRoom.tsx` - 待機室コンポーネント（参加状況を表示）

### Daily.co入室処理
- `backend/src/routes/calls.ts`:
  - `/api/calls/create-room` (14-173行目) - ルーム作成・待機室入室
  - `/api/calls/join-room` (179-274行目) - 実際の通話開始（Daily.coセッション入室）
- `backend/src/utils/daily.ts`:
  - `createDailyRoom()` (33-97行目) - Daily.coルーム作成（nbf: 15分前から入室可能）
  - `generateMeetingToken()` (140-167行目) - ミーティングトークン生成

### 入室状態管理
- `backend/src/routes/calls.ts`:
  - `/api/calls/status/:purchasedSlotId` (371-429行目) - 通話ステータス取得
  - `influencer_joined_at` / `fan_joined_at` をチェックして参加状態を返す
- `src/components/calls/CallWaitingRoom.tsx`:
  - 56-73行目: ステータスポーリング（5秒間隔）
  - 258-272行目: 参加状況表示（`status.participants.influencer_joined` / `status.participants.fan_joined` を使用）

### 問題の原因（コード調査結果）

#### Issue #1: 入室状態表示問題
- **原因**: `influencer_joined_at` / `fan_joined_at` は `/api/calls/join-room` で設定される（実際の通話開始時）
- **現状**: CallPageに入っただけでは `joined_at` が設定されないため、両方とも「待機中」と表示される
- **期待動作**: 自分がCallPageに入った → 自分: 待機中、相手: 未入室（`joined_at` が null の場合）

#### Issue #2: インフルエンサーの15分前入室問題
- **原因**: Daily.coルームの `nbf` は15分前に設定されているが、トークン生成時に時刻チェックが行われていない可能性
- **現状**: `backend/src/routes/calls.ts` の87行目に「待機室にはいつでも入室可能（15分制限を削除）」というコメントがある
- **期待動作**: インフルエンサーは15分前からDaily.coセッションに入室可能、ファンは開始時刻から入室可能

---

**作成日**: 2025-01-XX

