# Main Agent オーケストレーションプロンプトテンプレート

## 使用目的

Main Agentが全体のタスクを分解し、Sub Agentに振り分ける際に使用するプロンプトテンプレートです。

---

## 📋 基本テンプレート

```markdown
# Main Agent: タスク管理・オーケストレーション

## ユーザー指示
{{ユーザーからの指示をそのまま記載}}

## 依頼内容

### Step 1: タスク分析
以下の情報を分析してください：

1. **関連ドキュメントの確認**
   - 業務仕様: `/docs/business/{{業務名}}.md`
   - 機能仕様: `/docs/functional/{{機能名}}.md`（存在する場合）
   - 既存実装: `{{関連ファイルパス}}`

2. **タスクの種類判定**
   - [ ] 新機能追加
   - [ ] 既存機能の修正
   - [ ] バグ修正
   - [ ] リファクタリング
   - [ ] テスト追加

3. **依存関係の確認**
   - 前提となる機能・実装
   - 影響を受ける既存機能

### Step 2: タスク分解
以下の形式でタスクを分解してください：

```
【タスク分解】
1. テスト設計（Sub Agent 1: テストエキスパート）
   - 対象業務仕様: {{BR-xxx}}
   - 入力: /docs/business/{{業務名}}.md
   - 出力: /docs/test/plans/{{機能名}}_TEST_PLAN.md
   - 出力: e2e/{{機能名}}.spec.ts
   - 出力: src/{{コンポーネント}}.test.ts
   - 優先度: {{高/中/低}}
   - 推定工数: {{時間}}

2. 実装（Sub Agent 2: 実装エキスパート）
   - 対象機能仕様: {{FR-xxx}}
   - 入力: /docs/functional/{{機能名}}.md
   - 入力: 上記のテストコード
   - 出力: {{実装ファイルパス}}
   - 依存: タスク1（テスト設計）
   - 優先度: {{高/中/低}}
   - 推定工数: {{時間}}

3. レビュー（Sub Agent 3: レビューエキスパート）
   - 対象: 上記の実装コード
   - 依存: タスク2（実装）
   - 優先度: {{高/中/低}}
   - 推定工数: {{時間}}
```

### Step 3: Sub Agentへの指示生成
各Sub Agentに対して、具体的な指示を生成してください：

#### Sub Agent 1: テスト設計への指示
```
# テスト設計タスク

## 対象業務仕様
/docs/business/{{業務名}}.md の {{BR-xxx}}

## 依頼内容
{{機能名}}のテストを設計してください。

### 出力
1. テスト計画書: /docs/test/plans/{{機能名}}_TEST_PLAN.md
2. E2Eテスト: e2e/{{機能名}}.spec.ts
3. Unitテスト: src/{{コンポーネント}}.test.ts

### 要件
- 業務仕様（{{BR-xxx}}）に準拠すること
- 正常系・異常系・エッジケースを含むこと
- テストケースIDは TC-xxx-xxx 形式
- test.skip() は使わず、実装可能な状態で生成すること

### 重要
- テストコードのみを生成（実装コードは書かない）
- テストは失敗する状態でOK（実装がないため）
```

#### Sub Agent 2: 実装への指示
```
# 実装タスク

## 対象機能仕様
/docs/functional/{{機能名}}.md の {{FR-xxx}}

## 入力テストコード
e2e/{{機能名}}.spec.ts
src/{{コンポーネント}}.test.ts

## 依頼内容
テストが通るように実装してください。

### 出力
{{実装ファイルパスと内容}}

### 要件
- 機能仕様（{{FR-xxx}}）に準拠すること
- テストが通るまで修正を繰り返すこと（最大5回）
- エラーが発生した場合は報告すること

### 重要ルール
- テストファイルは原則変更しない（実装を修正する）
- 業務仕様と矛盾する場合は報告すること
```

#### Sub Agent 3: レビューへの指示
```
# レビータスク

## 対象実装コード
{{実装ファイルパスの一覧}}

## 依頼内容
コードレビューと品質チェックを行ってください。

### チェック項目
- コード品質（可読性、保守性）
- セキュリティ（SQLインジェクション、認証、認可）
- パフォーマンス（効率的な実装）
- エラーハンドリング
- テストカバレッジ

### 出力形式
- レビュー結果レポート（形式は指定）
- 修正提案（問題がある場合）

### 重要
- 問題があれば具体的な修正提案を含めること
- 優先度を付けること
```

### Step 4: 進捗管理
以下の形式で進捗を管理してください：

```
【進捗管理】
タスク1（テスト設計）: {{進行中/完了/失敗}}
タスク2（実装）: {{待機中/進行中/完了/失敗}}
タスク3（レビュー）: {{待機中/進行中/完了/失敗}}
```

### Step 5: 完了確認
全タスクが完了したら、以下の形式で完了報告を生成してください：

```
✅ タスク完了

【実装完了】
- テスト設計: {{完了/未完了}}
- 実装: {{完了/未完了}}
- レビュー: {{完了/未完了}}

【成果物】
- {{成果物の一覧}}

【テスト結果】
{{テスト実行結果}}

【レビュー結果】
{{レビュー結果のサマリー}}

【次のアクション】
{{ユーザーに確認すべき事項}}
```

## 重要ルール
- 各Sub Agentには具体的で明確な指示を出すこと
- 依存関係を明確にすること
- 進捗を定期的に確認すること
- 問題が発生した場合はユーザーに報告すること
```

---

## 📝 具体例

### 例1: 新機能「オークション終了時の自動決済」の実装

```markdown
# Main Agent: タスク管理・オーケストレーション

## ユーザー指示
「オークション終了時の自動決済機能を実装して」

## 依頼内容

### Step 1: タスク分析
以下の情報を分析してください：

1. **関連ドキュメントの確認**
   - 業務仕様: `/docs/business/payment.md` の BR-005
   - 機能仕様: `/docs/functional/payment.md` の FR-005
   - 既存実装: `backend/src/routes/auctions.ts`

2. **タスクの種類判定**
   - [x] 新機能追加

3. **依存関係の確認**
   - 前提: オークション終了処理が実装されていること
   - 影響: 決済処理、オークション状態管理

### Step 2: タスク分解
以下の形式でタスクを分解してください：

【タスク分解】
1. テスト設計（Sub Agent 1: テストエキスパート）
   - 対象業務仕様: BR-005「オークション終了時の自動決済」
   - 入力: /docs/business/payment.md
   - 出力: /docs/test/plans/auction_auto_payment_TEST_PLAN.md
   - 出力: e2e/auction-auto-payment.spec.ts
   - 出力: src/utils/payment-processor.test.ts
   - 優先度: 高
   - 推定工数: 4時間

2. 実装（Sub Agent 2: 実装エキスパート）
   - 対象機能仕様: FR-005「自動決済処理の実装」
   - 入力: /docs/functional/payment.md
   - 入力: 上記のテストコード
   - 出力: backend/src/routes/auctions.ts（更新）
   - 出力: supabase/functions/process-auction-payment.ts（新規）
   - 出力: src/utils/payment-processor.ts（新規）
   - 依存: タスク1（テスト設計）
   - 優先度: 高
   - 推定工数: 6時間

3. レビュー（Sub Agent 3: レビューエキスパート）
   - 対象: 上記の実装コード
   - 依存: タスク2（実装）
   - 優先度: 中
   - 推定工数: 2時間

### Step 3: Sub Agentへの指示生成
[各Sub Agentへの具体的な指示を生成]

### Step 4: 進捗管理
[進捗を管理]

### Step 5: 完了確認
[完了報告を生成]
```

---

## 🎯 使い方

### 1. プロンプトの準備

1. 上記のテンプレートをコピー
2. `{{変数}}` 部分を実際の値に置き換え
3. Cursorに貼り付け

### 2. 実行

1. Cursorのメインウィンドウでプロンプトを実行
2. Main Agentがタスクを分解し、Sub Agentへの指示を生成
3. 生成された指示を各Sub Agentに順次実行

### 3. 確認と調整

1. 生成されたタスク分解を確認
2. 必要に応じて調整
3. Sub Agentへの指示を承認

---

## ⚠️ 注意事項

### 変数の置き換え

テンプレート内の `{{変数}}` は必ず実際の値に置き換えてください：

- `{{業務名}}` → `payment`, `video-call`, `auction` など
- `{{機能名}}` → `auto-payment`, `call-status-management` など
- `{{BR-xxx}}` → `BR-005`, `BR-008` など
- `{{FR-xxx}}` → `FR-005`, `FR-008` など

### 依存関係の明確化

タスク間の依存関係を明確にしてください：

- タスク2はタスク1の完了後に開始
- タスク3はタスク2の完了後に開始

### 優先度の設定

タスクの優先度を適切に設定してください：

- **高**: 緊急度が高い、ブロッカーになる可能性がある
- **中**: 通常の優先度
- **低**: 任意対応でも良い

---

## 📚 関連ドキュメント

- [複数Agent開発ガイド](../MULTI_AGENT_DEVELOPMENT_GUIDE.md) - 複数Agentを使った開発方法（本ガイド）
- [AI-TDD開発ガイド（シングルAgent開発）](../AI_TDD_DEVELOPMENT_GUIDE.md) - 1つのAI Agentで全てのタスクを処理する方法（代替手法）
- [テストエキスパート用プロンプト](./test_agent.md) - Sub Agent 1用
- [実装エキスパート用プロンプト](./implementation_agent.md) - Sub Agent 2用
- [レビューエキスパート用プロンプト](./review_agent.md) - Sub Agent 3用

---

**最終更新**: 2026-01-02  
**作成者**: AI Assistant  
**承認者**: プロジェクトオーナー