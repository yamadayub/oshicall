# 実装エキスパート用プロンプトテンプレート

## 使用目的

Sub Agent 2（実装エキスパート）が機能仕様に基づいて実装コードを生成し、テストが通るまで修正を繰り返す際に使用するプロンプトテンプレートです。

---

## 📋 基本テンプレート

```markdown
# Sub Agent 2: 実装タスク

## 対象機能仕様
/docs/functional/{{機能名}}.md の {{FR-xxx}}

## 入力テストコード
e2e/{{機能名}}.spec.ts
src/{{コンポーネント}}.test.ts

## 依頼内容
テストが通るように実装してください。

### Step 1: 現状調査（まず報告）
以下の情報を調査し、報告してください：

1. **関連コードの確認**
   - 既存の実装ファイルを確認
   - 関連するAPIエンドポイントを確認
   - データベーススキーマを確認

2. **テストコードの確認**
   - テストが何を検証しようとしているか
   - 必要な実装要件

3. **実装方針の検討**
   - 実装すべき内容
   - 変更が必要なファイル
   - 新規作成が必要なファイル

4. **リスク・影響範囲**
   - 既存機能への影響
   - データベース変更の必要性
   - 外部API連携の必要性

以下の形式で報告してください：

```
【現状調査レポート】

■ 関連ファイル:
  - {{既存ファイルパス}}: {{役割}}
  - {{新規ファイルパス}}: {{作成予定}}

■ 現在の実装状況:
  - {{どこまで実装されているか}}
  - {{何が不足しているか}}

■ 実装方針:
  - {{実装の概要}}
  - {{変更内容}}

■ テストを通すために必要な変更:
  - {{変更概要1}}
  - {{変更概要2}}

■ リスク・影響範囲:
  - {{既存機能への影響}}
  - {{データベース変更の有無}}
```

### Step 2: 実装（承認後）
現状調査レポートに基づいて実装してください。

#### 実装ルール
- 機能仕様（FR-xxx）に準拠すること
- テストが通るまで修正を繰り返すこと（最大5回まで）
- エラーが発生した場合は報告すること
- テストファイルは原則変更しない（実装を修正する）

#### 実装フロー
1. **実装コード生成**
   - 関連ファイルを更新/作成
   - コードスタイルに準拠

2. **テスト実行**
   ```bash
   # Unitテスト実行
   npm run test -- src/{{コンポーネント}}.test.ts

   # E2Eテスト実行（該当する場合）
   npm run test:e2e -- --grep "TC-xxx-xxx"
   ```

3. **結果確認**
   - 成功 → Step 3へ
   - 失敗 → エラー解析 → 修正 → 2に戻る（最大5回まで）

4. **エラー解析（失敗時）**
   - エラーメッセージを解析
   - 問題箇所を特定
   - 原因を推定

5. **修正実装（失敗時）**
   - 実装コードを修正
   - 修正内容を記録

#### 各試行の記録
以下の形式で各試行を記録してください：

```
【試行 1/5】
- 結果: {{成功/失敗}}
- エラー: {{エラーメッセージ（失敗時）}}
- 原因: {{推定原因（失敗時）}}
- 修正: {{実施した修正（失敗時）}}
```

### Step 3: 完了報告（成功時）
テストが通過したら、以下の形式で完了報告をしてください：

```
✅ 実装完了

【実装完了】
- 実装: 完了
- テスト結果: {{全テスト通過}}

【成果物】
- {{実装ファイルパスの一覧}}

【変更内容】
- {{変更内容1}}
- {{変更内容2}}

【テスト結果】
✅ Unitテスト: {{数}}個全て通過
✅ E2Eテスト: {{数}}個全て通過

【備考】
{{補足情報}}
```

### Step 4: 手動介入の依頼（最大試行回数超過時）
最大試行回数（5回）を超えてもテストが通過しない場合は、以下の形式で手動介入を依頼してください：

```
⚠️ 手動介入が必要

【問題】
- 最大試行回数（5回）を超えてもテストが通過しない
- エラー: {{最後のエラーメッセージ}}

【試行履歴】
1. {{エラー1}}
2. {{エラー2}}
...

【推定原因】
{{根本原因の推定}}

【次のアクション】
{{ユーザーに確認すべき事項}}
```

## 重要ルール
- テストファイルは原則変更しない（実装を修正する）
- 業務仕様と矛盾する場合は報告すること
- 実装コードは既存のコードスタイルに合わせること
- セキュリティとパフォーマンスを考慮すること
```

---

## 📝 具体例

### 例1: CallPageコンポーネントの実装

```markdown
# Sub Agent 2: 実装タスク

## 対象機能仕様
/docs/functional/call-status-management.md の FR-008

## 入力テストコード
e2e/video-call-entry.spec.ts の TC-008-001
src/components/CallPage.test.ts

## 依頼内容
テストが通るように実装してください。

### Step 1: 現状調査（まず報告）
以下の情報を調査し、報告してください：

1. **関連コードの確認**
   - 既存の実装ファイル: `src/components/CallPage.tsx`
   - 関連するAPI: `src/api/call.ts`
   - データベース: `supabase/migrations/...`（必要に応じて）

2. **テストコードの確認**
   - TC-008-001: インフルエンサーが先に入室（ファン未入室表示）
   - テストが検証する内容: Supabaseリアルタイム購読による入室状態の表示

3. **実装方針の検討**
   - Supabaseの`realtime`チャンネルを購読
   - 相手の入室状態をリアルタイムで取得・表示

4. **リスク・影響範囲**
   - 既存機能への影響: なし（新機能追加）
   - データベース変更: なし
   - 外部API連携: Supabase Realtime

【現状調査レポート】

■ 関連ファイル:
  - src/components/CallPage.tsx: CallPageコンポーネント（更新）
  - src/api/call.ts: 通話関連API（確認のみ）

■ 現在の実装状況:
  - CallPageコンポーネントは基本的な構造は実装済み
  - Supabaseリアルタイム購読が未実装

■ 実装方針:
  - useEffect内でSupabaseのrealtimeチャンネルを購読
  - 相手の入室状態をstateで管理
  - コンポーネントの表示を更新

■ テストを通すために必要な変更:
  - CallPage.tsxにリアルタイム購読ロジックを追加
  - 相手の入室状態を表示するUIコンポーネントを追加

■ リスク・影響範囲:
  - 既存機能への影響: なし
  - データベース変更: なし

### Step 2: 実装（承認後）
[実装コードを生成し、テストを実行]

【試行 1/5】
- 結果: 成功
- エラー: なし

### Step 3: 完了報告
✅ 実装完了

【実装完了】
- 実装: 完了
- テスト結果: 全テスト通過

【成果物】
- src/components/CallPage.tsx（更新）

【変更内容】
- Supabase Realtime購読ロジックを追加
- 相手の入室状態を表示するUIコンポーネントを追加

【テスト結果】
✅ Unitテスト: 1個通過
✅ E2Eテスト: TC-008-001通過

【備考】
- Supabase Realtimeのチャンネル名は `call-${talkId}` 形式
- 入室状態は `presence` イベントで管理
```

---

## 🔄 テスト実行→修正ループの詳細

### エラーパターンと対処法

| エラータイプ | 対処法 | プロンプト例 |
|------------|--------|------------|
| **コンパイルエラー** | 型エラーや構文エラーを修正 | 「TypeScriptのコンパイルエラーを修正してください」 |
| **実行時エラー** | nullチェック、型変換を追加 | 「実行時エラーを修正してください。nullチェックを追加してください」 |
| **アサーションエラー** | 実装ロジックを修正（期待値に合わせる） | 「アサーションエラーを修正してください。期待値に合わせて実装を修正してください」 |
| **タイムアウトエラー** | セレクタの修正、wait処理の追加 | 「タイムアウトエラーを修正してください。セレクタを確認し、適切な待機処理を追加してください」 |

### 修正ループのプロンプト例

```
# エラー修正

## エラー内容
[ここにエラーメッセージを貼り付け]

## 対象ファイル
{{ファイルパス}}

## 依頼内容
このエラーを修正してください。

### 修正方針
1. エラーメッセージを解析
2. 問題箇所を特定
3. 修正を実装
4. テストを再実行

### 重要
- 業務仕様に準拠すること
- 既存のコードスタイルに合わせること
- テストファイルは変更しない
```

---

## 🎯 使い方

### 1. プロンプトの準備

1. 上記のテンプレートをコピー
2. `{{変数}}` 部分を実際の値に置き換え
3. Cursorに貼り付け

### 2. 実行

1. Cursorでプロンプトを実行
2. Step 1の現状調査レポートを確認・承認
3. Step 2の実装を承認
4. テスト実行→修正ループを監視

### 3. 確認と調整

1. 実装コードを確認
2. テスト結果を確認
3. 必要に応じて手動介入

---

## ⚠️ 注意事項

### テストファイルの変更禁止

- **原則**: テストファイルは変更しない
- **例外**: テストコード自体に問題がある場合のみ修正
- **確認**: 実装コードを修正することでテストが通るか確認

### 最大試行回数の管理

- **デフォルト**: 5回
- **超過時**: 手動介入を依頼
- **記録**: 各試行の結果を記録

### エラー解析の精度

- **詳細なログ**: エラーメッセージの全体を確認
- **スタックトレース**: エラーが発生した箇所を特定
- **原因推定**: なぜエラーが発生したかを考える

---

## 📚 関連ドキュメント

- [複数Agent開発ガイド](../MULTI_AGENT_DEVELOPMENT_GUIDE.md) - 複数Agentを使った開発方法
- [AI-TDD開発ガイド（シングルAgent開発）](../AI_TDD_DEVELOPMENT_GUIDE.md) - 1つのAI Agentで全てのタスクを処理する方法
- [コード変更ワークフロー](../CODE_CHANGE_WORKFLOW.md) - コード変更の承認フロー
- [Main Agent用プロンプト](./main_agent_orchestration.md) - Main Agentからの指示

---

**最終更新**: 2026-01-02  
**作成者**: AI Assistant  
**承認者**: プロジェクトオーナー