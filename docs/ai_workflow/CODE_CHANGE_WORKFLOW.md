# コード変更ワークフローガイドライン

## 概要

このプロジェクトにおけるコード変更のワークフローを定義します。安全で効率的な開発を確保するためのガイドラインです。

## ⚠️ 最重要ルール（AI Assistant必須遵守）

### 🚨 絶対禁止事項
**承認なしでのコード修正は絶対に行わないこと**

- **コード修正ツールの使用禁止**: ユーザーが「承認」「OK」「進めて」と明示的に承認するまで、`search_replace`、`write`、`edit_notebook`などのコード修正ツールを使用してはいけません
- **提案なしの実行禁止**: 修正内容を提案せずに、いきなりコードを変更してはいけません
- **推測による修正禁止**: ユーザーの意図を推測して、承認なしで修正してはいけません
- **「ついでに」の修正禁止**: 指示されていない変更を「ついでに」行ってはいけません

### ✅ 必須遵守事項
1. **必ず提案を先に提示**: 修正内容を明確に説明し、変更が必要なファイル一覧、各ファイルでの変更概要、影響範囲、リスクを提示すること
2. **明示的な承認を待つ**: ユーザーが「承認」「OK」「進めて」などと明示的に承認するまで、コード変更は絶対に行わないこと
3. **一度に1ファイルずつ**: 承認後も、一度に変更するのは1ファイルずつとし、各変更後に確認を求めること
4. **このドキュメントを常に参照**: コード変更を行う前に、必ずこのドキュメントを確認すること

## 基本原則

### 🔴 禁止事項
- **即時コード編集の禁止**: 修正内容を提案してから、ユーザーの承認を得てからコードに反映すること
- **リスクの高い変更の即時実行禁止**: RLSポリシー、データベーススキーマ、セキュリティ関連の変更は必ず提案・承認を経ること
- **承認なしのコード修正禁止**: 上記「最重要ルール」を参照

### ✅ 必須事項
- **提案→承認→実行の順守**: 全てのコード変更でこの順序を守ること
- **影響範囲の明確化**: 変更が及ぼす影響を事前に説明すること
- **ロールバック計画**: 問題発生時の対応策を提示すること
- **明示的な承認の取得**: ユーザーが「承認」「OK」「進めて」と明示的に言うまで、コードの変更は絶対に行わないこと

## ワークフロー

### フェーズ1: 問題分析
1. エラーメッセージ、ログ、動作の確認
2. 根本原因の特定
3. 影響範囲の調査

### フェーズ2: 修正提案
**⚠️ このフェーズではコード修正ツールを使用してはいけません。提案のみを行います。**

1. **具体的な修正内容を記述**
   - 変更が必要なファイル一覧
   - 各ファイルでの変更概要
   - 変更内容の詳細（コード例を含む）
   - 期待される結果

2. **リスク評価**
   - 影響を受ける機能
   - 影響範囲の分析
   - ロールバック方法
   - テスト方法
   - リスクや注意点

3. **代替案の提示**（可能な場合）
   - より安全な方法
   - 段階的なアプローチ

4. **承認を求める**
   - 「承認をお願いします」「この修正で進めますか？」など、明示的に承認を求めること

### フェーズ3: 承認待ち
**⚠️ このフェーズではコード修正ツールを使用してはいけません。**

- ユーザーの承認を待つ（「承認」「OK」「進めて」などの明示的な承認を待つ）
- 質問への回答
- 必要に応じて提案の修正
- **承認なしでコードを修正してはいけません**

### フェーズ4: 実行
**✅ ユーザーが明示的に承認した後のみ、このフェーズに進みます。**

1. **承認後、コード変更を実行**
   - 一度に1ファイルずつ変更すること
   - 各変更後に確認を求めること
   - コード修正ツール（`search_replace`、`write`など）を使用するのはこのフェーズから

2. テスト実施
3. コミット・デプロイ

### フェーズ5: GitHubへのPush（Routine化）
実装完了後は、以下の手順でGitHubにPushします。

#### 必須手順
1. **変更ファイルの確認**
   ```bash
   git status
   ```

2. **関連ファイルのみをステージング**
   ```bash
   # 主要な変更ファイルのみを追加（一時ファイルや自動生成ファイルは除外）
   git add [変更したファイル]
   ```

3. **コミットメッセージの作成**
   - 変更内容を明確に記述
   - フォーマット: `[type]: [簡潔な説明]`
   - 詳細な変更内容を本文に記載
   ```bash
   git commit -m "feat: [機能名] の実装

   - 変更内容1
   - 変更内容2
   - ドキュメント更新"
   ```

4. **GitHubへのPush**
   ```bash
   git push origin main
   ```

#### コミットメッセージのフォーマット
- **feat**: 新機能追加
- **fix**: バグ修正
- **docs**: ドキュメント更新
- **refactor**: リファクタリング
- **test**: テスト追加・修正
- **chore**: その他の変更（設定ファイルなど）

#### 除外すべきファイル
以下のファイルは通常コミットに含めません：
- `supabase/.temp/*` - 一時ファイル
- `node_modules/` - 依存パッケージ
- `.env*` - 環境変数ファイル（`.example` は含める）
- 自動生成ファイル

#### 注意事項
- **承認後のみPush**: ユーザーの承認を得てからPushすること
- **コミットメッセージの明確化**: 変更内容が分かるように記述すること
- **関連ファイルの確認**: 意図しないファイルが含まれていないか確認すること

## 変更タイプ別のガイドライン

### 🟢 低リスク変更
**⚠️ 重要: 低リスク変更であっても、承認なしでコードを修正してはいけません。**

**提案・承認必須（承認は簡易的で可）:**
- UIテキストの修正
- コメント追加
- ログ出力の追加
- タイポ修正

**承認後の実行:**
- ユーザーが「承認」「OK」などと明示的に承認した後、コード変更を実行すること

### 🟡 中リスク変更
**提案・承認必須:**
- 新機能追加
- 既存機能の拡張
- 設定変更
- APIエンドポイント追加

### 🔴 高リスク変更
**提案・承認必須 + 詳細レビュー:**
- データベーススキーマ変更
- RLSポリシー変更
- セキュリティ関連変更
- 認証・認可ロジック変更
- Migrationファイル作成

## エスカレーション基準

### 🚨 即時エスカレーション
- データベースの破損リスク
- セキュリティホールの可能性
- 既存機能の完全停止リスク
- 複数チームメンバーに影響

### ⚠️ 要相談
- ユーザー体験の大幅変更
- パフォーマンスに影響する変更
- サードパーティAPIの変更

## ロールバック計画

### 必須項目
- **変更前の状態保存**: git stash または 別ブランチ
- **即時ロールバック方法**: 変更を戻す具体的手順
- **検証方法**: ロールバック後の動作確認

### 緊急ロールバック手順
```bash
# コード変更の即時ロールバック
git checkout HEAD -- [変更ファイル]

# データベース変更のロールバック
# (migrationファイルがある場合はDROP文を実行)
```

## コミュニケーション

### 提案時の必須情報
```
## 修正提案: [問題の簡潔な説明]

### 問題分析
[根本原因と影響範囲]

### 修正内容
[具体的な変更内容]

### リスク評価
[影響とロールバック計画]

### テスト方法
[動作確認手順]

### 承認をお願いします
```

### 承認後の実行報告
```
## ✅ 修正完了: [問題の説明]

### 実行内容
[実際に変更した内容]

### テスト結果
[動作確認結果]

### コミット情報
[コミットハッシュなど]
```

## 例外ケース

### 緊急修正
- **条件**: サービス停止、セキュリティ侵害、データ損失のリスク
- **手順**: 問題の概要を報告後、即時実行
- **後処理**: 実行後に詳細を報告し、承認を得る

### 細かい調整
- **条件**: 同じ問題の繰り返しの小さな修正
- **手順**: 初回のみ提案・承認、以後は簡易報告

## 定期レビュー

- **毎月**: このガイドラインの有効性をレビュー
- **変更時**: プロジェクトメンバーに通知
- **改善**: フィードバックを基に更新

---

---

## AI Assistant向けチェックリスト

コード変更を行う前に、以下を必ず確認してください：

- [ ] 修正内容を提案したか？
- [ ] 変更が必要なファイル一覧を提示したか？
- [ ] 各ファイルでの変更概要を説明したか？
- [ ] 影響範囲を分析したか？
- [ ] リスクや注意点を提示したか？
- [ ] ユーザーが「承認」「OK」「進めて」と明示的に承認したか？
- [ ] 承認後、一度に1ファイルずつ変更しているか？

**上記のいずれかが未完了の場合、コード修正ツールを使用してはいけません。**

---

**最終更新**: 2026-01-12
**作成者**: AI Assistant
**承認者**: プロジェクトオーナー
**重要更新**: 承認なしでのコード修正を絶対禁止とするルールを追加