# 複数Agent開発ガイド (Multi-Agent Development Guide)

## 概要

本ドキュメントは、複数のAI Agent（Main Agent + Sub Agent）を活用した開発手法を定義します。
Main Agentが全体のオーケストレーションを行い、Sub Agentにタスクを振り分け、レビューしながらテストを通過するまで開発を進める方法を説明します。

**開発手法の選択**:
- **マルチAgent開発（本ガイド）**: 複数のAI Agent（Main Agent + Sub Agent）を活用した開発手法
- **シングルAgent開発**: 1つのAI Agent（Cursor/Claude）で全てのタスクを処理する方法は [`AI_TDD_DEVELOPMENT_GUIDE.md`](./AI_TDD_DEVELOPMENT_GUIDE.md) を参照してください

**最終更新**: 2026-01-12
**対象プロジェクト**: OshiCall

---

## 🎯 目的

- **タスクの分割と並行処理**: 複数のAgentが異なるタスクを同時に処理
- **専門性の活用**: 各Agentの専門領域を最大限に活用
- **品質保証**: Main Agentがレビューを行い、品質を担保
- **効率化**: 人間のレビュー負担を軽減しつつ、高い品質を維持

---

## 🛠️ Agent構成と役割

### Agent一覧

| Agent | 役割 | 担当タスク | 使用ツール |
|-------|------|-----------|-----------|
| **Main Agent** | オーケストレーター | 全体の統括、タスク分解、レビュー、進捗管理 | Cursor (Claude) |
| **Sub Agent 1** | テストエキスパート | テスト設計、テストコード生成、テスト実行 | Cursor (Claude) |
| **Sub Agent 2** | 実装エキスパート | 実装コード生成、リファクタリング | Cursor (Claude) |
| **Sub Agent 3** | レビューエキスパート | コードレビュー、品質チェック、最適化提案 | Cursor (Claude) |

### 各Agentの詳細

#### Main Agent（オーケストレーター）

**役割**:
- ユーザーからの指示を理解し、全体のタスクを分解
- Sub Agentにタスクを振り分け
- 各Agentの成果物をレビュー
- 進捗を管理し、完了を判定

**能力**:
- タスクの優先順位付け
- 依存関係の管理
- 品質基準の設定
- エスカレーション判断

**使用ツール**: Cursor (Claude)

#### Sub Agent 1: テストエキスパート

**役割**:
- 業務仕様からテストケースを設計
- E2Eテスト（Playwright）とUnitテスト（Vitest）を生成
- テストを実行し、結果を解析
- テスト計画書を作成

**専門領域**:
- テスト設計（正常系/異常系/エッジケース）
- テスト自動化
- テスト実行とエラー解析
- テストカバレッジ分析

**使用ツール**: Cursor (Claude)

#### Sub Agent 2: 実装エキスパート

**役割**:
- 機能仕様に基づいて実装コードを生成
- テストが通るように実装を修正
- リファクタリングとコード改善
- パフォーマンス最適化

**専門領域**:
- React/TypeScript実装
- Supabase連携
- Stripe/Daily.co統合
- 状態管理とデータフロー

**使用ツール**: Cursor (Claude)

#### Sub Agent 3: レビューエキスパート

**役割**:
- コードレビューと品質チェック
- バグの早期発見
- コードスタイルの統一
- セキュリティチェック

**専門領域**:
- コード品質評価
- ベストプラクティス準拠
- パフォーマンス分析
- セキュリティ評価

**使用ツール**: Cursor (Claude)

---

## 🔄 マルチAgent開発フロー

### 全体フロー

```
┌─────────────────────────────────────────┐
│ Main Agent: タスク受領・分解              │
│ - ユーザー指示を理解                      │
│ - タスクを分解                           │
│ - 優先順位を設定                         │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│ Main Agent: タスク振り分け               │
│ ├── Sub Agent 1: テスト設計              │
│ ├── Sub Agent 2: 実装開始               │
│ └── Sub Agent 3: 準備待機               │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│ Sub Agent 1: テスト設計・生成            │
│ - 業務仕様からテストケース生成            │
│ - テストコード生成                       │
│ - テスト計画書作成                       │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│ Sub Agent 2: 実装                       │
│ - 機能仕様に基づいて実装                 │
│ - テストを実行                           │
│ - 失敗したら修正（ループ）                │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│ Sub Agent 3: レビュー                   │
│ - コードレビュー                         │
│ - 品質チェック                           │
│ - 問題があれば修正提案                   │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│ Main Agent: 最終確認・完了               │
│ - 全タスクの完了確認                     │
│ - 品質基準の確認                         │
│ - ユーザーに完了報告                     │
└─────────────────────────────────────────┘
```

### 詳細フロー（Phase別）

#### Phase 0: タスク受領・分解（Main Agent）

**入力**: ユーザーからの指示  
**出力**: タスク分解結果、優先順位

**プロセス**:
1. ユーザー指示を理解
2. 関連する業務仕様・機能仕様を確認
3. タスクを分解（テスト設計、実装、レビュー）
4. 優先順位を設定
5. Sub Agentに割り当て

**プロンプト例**: [Main Agent用プロンプトテンプレート](./templates/main_agent_orchestration.md)

#### Phase 1: テスト設計（Sub Agent 1）

**入力**: 業務仕様、タスク分解結果  
**出力**: テスト計画書、テストコード

**プロセス**:
1. 業務仕様（BR-xxx）を確認
2. テストケースを設計
3. テストコードを生成（Playwright/Vitest）
4. テスト計画書を作成
5. Main Agentに成果物を報告

**プロンプト例**: [テストエキスパート用プロンプトテンプレート](./templates/test_agent.md)

#### Phase 2: 実装（Sub Agent 2）

**入力**: 機能仕様、テストコード  
**出力**: 実装コード、テスト実行結果

**プロセス**:
1. 機能仕様（FR-xxx）を確認
2. テストコードを確認
3. 実装コードを生成
4. テストを実行
5. 失敗したら修正（最大5回まで）
6. Main Agentに成果物を報告

**プロンプト例**: [実装エキスパート用プロンプトテンプレート](./templates/implementation_agent.md)

#### Phase 3: レビュー（Sub Agent 3）

**入力**: 実装コード、テスト実行結果  
**出力**: レビュー結果、修正提案

**プロセス**:
1. 実装コードをレビュー
2. テスト実行結果を確認
3. コード品質を評価
4. 問題があれば修正提案
5. Main Agentにレビュー結果を報告

**プロンプト例**: [レビューエキスパート用プロンプトテンプレート](./templates/review_agent.md)

#### Phase 4: 最終確認・完了（Main Agent）

**入力**: 全Agentの成果物  
**出力**: 完了報告

**プロセス**:
1. 全タスクの完了確認
2. 品質基準の確認
3. テスト通過の確認
4. ユーザーに完了報告

---

## 📋 具体的なワークフロー例

### 例1: 新機能「オークション終了時の自動決済」の実装

#### Step 1: Main Agent - タスク受領・分解

**ユーザー指示**:
```
「オークション終了時の自動決済機能を実装して」
```

**Main Agentの処理**:
1. 関連する業務仕様を確認: `/docs/business/payment.md`
2. タスクを分解:
   - **タスク1**: テスト設計（Sub Agent 1）
   - **タスク2**: 実装（Sub Agent 2）
   - **タスク3**: レビュー（Sub Agent 3）

**タスク分解結果**:
```
【タスク分解】
1. テスト設計（Sub Agent 1）
   - 業務仕様: /docs/business/payment.md BR-005
   - 出力: /docs/test/plans/auction_auto_payment_TEST_PLAN.md
   - 出力: e2e/auction-auto-payment.spec.ts
   - 優先度: 高

2. 実装（Sub Agent 2）
   - 機能仕様: /docs/functional/payment.md FR-005
   - 入力: 上記のテストコード
   - 出力: backend/src/routes/auctions.ts（更新）
   - 出力: supabase/functions/process-auction-payment.ts（新規）
   - 優先度: 高

3. レビュー（Sub Agent 3）
   - 入力: 上記の実装コード
   - 出力: レビュー結果、修正提案
   - 優先度: 中
```

#### Step 2: Sub Agent 1 - テスト設計

**Main Agentの指示**:
```
# テスト設計タスク

## 対象業務仕様
/docs/business/payment.md の BR-005

## 依頼内容
オークション終了時の自動決済機能のテストを設計してください。

### 出力
1. テスト計画書: /docs/test/plans/auction_auto_payment_TEST_PLAN.md
2. E2Eテスト: e2e/auction-auto-payment.spec.ts
3. Unitテスト: src/utils/payment-processor.test.ts

### 要件
- 業務仕様（BR-005）に準拠すること
- 正常系・異常系・エッジケースを含むこと
- テストケースIDは TC-005-xxx 形式
```

**Sub Agent 1の処理**:
1. 業務仕様を確認
2. テストケースを設計
3. テストコードを生成
4. Main Agentに報告

**成果物**:
- ✅ `/docs/test/plans/auction_auto_payment_TEST_PLAN.md`
- ✅ `e2e/auction-auto-payment.spec.ts`
- ✅ `src/utils/payment-processor.test.ts`

#### Step 3: Sub Agent 2 - 実装

**Main Agentの指示**:
```
# 実装タスク

## 対象機能仕様
/docs/functional/payment.md の FR-005

## 入力テストコード
e2e/auction-auto-payment.spec.ts
src/utils/payment-processor.test.ts

## 依頼内容
テストが通るように実装してください。

### 出力
1. backend/src/routes/auctions.ts（更新）
2. supabase/functions/process-auction-payment.ts（新規）
3. src/utils/payment-processor.ts（新規）

### 要件
- 機能仕様（FR-005）に準拠すること
- テストが通るまで修正を繰り返すこと（最大5回）
- エラーが発生した場合は報告すること
```

**Sub Agent 2の処理**:
1. 機能仕様を確認
2. テストコードを確認
3. 実装コードを生成
4. テストを実行
5. 失敗したら修正（ループ）
6. Main Agentに報告

**成果物**:
- ✅ `backend/src/routes/auctions.ts`（更新完了）
- ✅ `supabase/functions/process-auction-payment.ts`（新規作成）
- ✅ `src/utils/payment-processor.ts`（新規作成）
- ✅ テスト実行結果: 全テスト通過

#### Step 4: Sub Agent 3 - レビュー

**Main Agentの指示**:
```
# レビータスク

## 対象実装コード
backend/src/routes/auctions.ts
supabase/functions/process-auction-payment.ts
src/utils/payment-processor.ts

## 依頼内容
コードレビューと品質チェックを行ってください。

### チェック項目
- コード品質（可読性、保守性）
- セキュリティ（SQLインジェクション、認証）
- パフォーマンス（効率的な実装）
- エラーハンドリング
- テストカバレッジ

### 出力
- レビュー結果レポート
- 修正提案（問題がある場合）
```

**Sub Agent 3の処理**:
1. 実装コードをレビュー
2. セキュリティチェック
3. パフォーマンス分析
4. 修正提案を生成
5. Main Agentに報告

**レビュー結果**:
```
【レビュー結果】
✅ コード品質: 良好
✅ セキュリティ: 問題なし
⚠️ パフォーマンス: 改善の余地あり
   - 提案: 決済処理を非同期で実行
✅ エラーハンドリング: 適切
✅ テストカバレッジ: 十分

【修正提案】
1. 決済処理を非同期で実行（パフォーマンス改善）
2. エラーログの詳細化（デバッグ性向上）
```

#### Step 5: Main Agent - 最終確認・完了

**Main Agentの処理**:
1. 全Agentの成果物を確認
2. テスト通過を確認
3. レビュー結果を確認
4. ユーザーに完了報告

**完了報告**:
```
✅ タスク完了

【実装完了】
- テスト設計: 完了
- 実装: 完了
- レビュー: 完了

【成果物】
- テスト計画書: /docs/test/plans/auction_auto_payment_TEST_PLAN.md
- E2Eテスト: e2e/auction-auto-payment.spec.ts
- Unitテスト: src/utils/payment-processor.test.ts
- 実装コード: backend/src/routes/auctions.ts, ...

【テスト結果】
✅ 全テスト通過

【レビュー結果】
⚠️ パフォーマンス改善の提案あり（任意対応）

【次のアクション】
レビュー結果の修正提案に対応するか確認してください。
```

---

## 🤝 Agent間の通信プロトコル

### タスク定義フォーマット

```markdown
# タスク定義

## タスクID
TASK-{{機能名}}-{{タイムスタンプ}}

## 担当Agent
{{Agent名}}

## 入力
- 業務仕様: {{パス}}
- 機能仕様: {{パス}}
- テストコード: {{パス}}
- 実装コード: {{パス}}

## 出力
- 成果物1: {{パス}}
- 成果物2: {{パス}}

## 要件
- 要件1
- 要件2

## 制約
- 制約1
- 制約2

## 優先度
{{高/中/低}}

## 期限
{{期限}}

## 関連タスク
- 依存タスク: {{タスクID}}
- 後続タスク: {{タスクID}}
```

### 成果物フォーマット

```markdown
# 成果物報告

## タスクID
{{タスクID}}

## 担当Agent
{{Agent名}}

## ステータス
{{完了/進行中/失敗}}

## 成果物
- 成果物1: {{パス}} (ステータス: {{完了/未完了}})
- 成果物2: {{パス}} (ステータス: {{完了/未完了}})

## 実行結果
{{成功/失敗/部分成功}}

## エラー（発生した場合）
- エラー1: {{エラーメッセージ}}
- 原因: {{原因}}
- 対処: {{対処方法}}

## 補足情報
{{その他の情報}}
```

### レビュー結果フォーマット

```markdown
# レビュー結果

## タスクID
{{タスクID}}

## レビュー対象
{{ファイルパス}}

## レビュー結果
✅ 問題なし / ⚠️ 改善の余地あり / ❌ 修正必要

## チェック項目
- コード品質: {{評価}}
- セキュリティ: {{評価}}
- パフォーマンス: {{評価}}
- エラーハンドリング: {{評価}}
- テストカバレッジ: {{評価}}

## 問題点（該当する場合）
1. 問題1: {{説明}}
   - 箇所: {{ファイル:行番号}}
   - 提案: {{修正提案}}

## 修正提案（該当する場合）
1. 提案1: {{説明}}
   - 優先度: {{高/中/低}}
   - 影響範囲: {{説明}}
```

---

## 🛠️ Cursorでの実装方法

### Main Agentとしての使用

**方法**: Cursorのメインウィンドウで全体的なタスク管理を行う

**プロンプト例**:
```
# Main Agent: タスク管理

## ユーザー指示
「{{機能名}}を実装して」

## 依頼内容
1. タスクを分解してください
2. 各Sub Agentにタスクを振り分けてください
3. 進捗を管理してください
4. 完了を確認してください

## Sub Agentへの指示
[各Sub Agent用のプロンプトを生成]
```

### Sub Agentとしての使用

**方法1: @file参照で疑似的に実現**

```
# Sub Agent 1: テスト設計

## 対象
@docs/business/payment.md

## 依頼内容
テスト設計をしてください。
```

**方法2: 段階的なタスク実行**

1. **Step 1**: テスト設計（1つのプロンプト）
2. **Step 2**: 実装（別のプロンプト）
3. **Step 3**: レビュー（別のプロンプト）

**プロンプト例**:
```
# Step 1: テスト設計のみ
[テストエキスパート用プロンプト]

# Step 2: 実装のみ（Step 1の成果物を参照）
[実装エキスパート用プロンプト]

# Step 3: レビューのみ（Step 2の成果物を参照）
[レビューエキスパート用プロンプト]
```

### 将来の拡張: Claude Code CLIとの連携

将来的には、Claude Code CLIを使用して複数のAgentを並列実行することも可能です：

```bash
# Main Agentが制御
claude-code orchestrate \
  --test-agent "test design" \
  --implementation-agent "implementation" \
  --review-agent "review"
```

---

## ✅ チェックリスト

### Main Agent用チェックリスト

- [ ] ユーザー指示を理解した
- [ ] 関連する業務仕様・機能仕様を確認した
- [ ] タスクを分解した
- [ ] 優先順位を設定した
- [ ] Sub Agentにタスクを振り分けた
- [ ] 進捗を管理した
- [ ] 全タスクの完了を確認した
- [ ] 品質基準を確認した
- [ ] ユーザーに完了報告した

### Sub Agent 1（テストエキスパート）用チェックリスト

- [ ] 業務仕様（BR-xxx）を確認した
- [ ] テストケースを設計した
- [ ] テストコードを生成した（Playwright/Vitest）
- [ ] テスト計画書を作成した
- [ ] Main Agentに成果物を報告した

### Sub Agent 2（実装エキスパート）用チェックリスト

- [ ] 機能仕様（FR-xxx）を確認した
- [ ] テストコードを確認した
- [ ] 実装コードを生成した
- [ ] テストを実行した
- [ ] 失敗したら修正した（最大5回まで）
- [ ] 全テストが通過した
- [ ] Main Agentに成果物を報告した

### Sub Agent 3（レビューエキスパート）用チェックリスト

- [ ] 実装コードをレビューした
- [ ] セキュリティチェックを実施した
- [ ] パフォーマンス分析を実施した
- [ ] エラーハンドリングを確認した
- [ ] テストカバレッジを確認した
- [ ] 問題があれば修正提案を生成した
- [ ] Main Agentにレビュー結果を報告した

---

## 🎬 実践例: video-call-entry テストのマルチAgent実装

### シナリオ: BR-008, BR-009, BR-010 のテスト実装

#### Step 1: Main Agent - タスク分解

**ユーザー指示**:
```
「video-call-entryのテストを実装して。現在test.skip()されているテストを解除して」
```

**Main Agentの処理**:
```
【タスク分解】
1. テスト設計（Sub Agent 1）
   - 対象: BR-008, BR-009, BR-010
   - 出力: テスト計画書、テストコード更新
   - 優先度: 高

2. 実装（Sub Agent 2）
   - 対象: CallPageコンポーネント、関連API
   - 入力: 上記のテストコード
   - 出力: 実装コード
   - 優先度: 高

3. レビュー（Sub Agent 3）
   - 対象: 実装コード
   - 出力: レビュー結果
   - 優先度: 中
```

#### Step 2: Sub Agent 1 - テスト設計

**成果物**:
- ✅ `test.skip()` を削除し、テストコードを実装可能な状態に更新
- ✅ `/docs/test/plans/video-call-entry_TEST_PLAN.md` を更新

#### Step 3: Sub Agent 2 - 実装

**実装内容**:
- ✅ Supabaseリアルタイム購読の実装
- ✅ Daily.co接続タイミング制御の実装
- ✅ 入室状態管理の実装

**テスト実行結果**:
- ✅ TC-008-001: 通過
- ✅ TC-008-002: 通過
- ⚠️ TC-008-003: 失敗 → 修正 → 通過
- ...

#### Step 4: Sub Agent 3 - レビュー

**レビュー結果**:
```
✅ コード品質: 良好
✅ セキュリティ: 問題なし
⚠️ パフォーマンス: リアルタイム購読の最適化を推奨
✅ エラーハンドリング: 適切
✅ テストカバレッジ: 十分（15/15テスト通過）
```

#### Step 5: Main Agent - 完了報告

**完了報告**:
```
✅ タスク完了

【実装完了】
- テスト設計: 完了（15テストケース）
- 実装: 完了（全テスト通過）
- レビュー: 完了

【成果物】
- e2e/video-call-entry.spec.ts（15テストケース全て実装）
- src/components/CallPage.tsx（更新）
- 関連API（更新）

【テスト結果】
✅ 全15テストケース通過

【次のアクション】
レビュー結果のパフォーマンス最適化は任意対応。
```

---

## 📚 関連ドキュメント

### 開発手法
- [AI-TDD開発ガイド（シングルAgent開発）](./AI_TDD_DEVELOPMENT_GUIDE.md) - 1つのAI Agentで全てのタスクを処理する方法（本ガイドの代替手法）

### プロンプトテンプレート
- [Main Agent用プロンプト](./templates/main_agent_orchestration.md) - オーケストレーション用
- [テストエキスパート用プロンプト](./templates/test_agent.md) - テスト生成用
- [実装エキスパート用プロンプト](./templates/implementation_agent.md) - 実装用
- [レビューエキスパート用プロンプト](./templates/review_agent.md) - レビュー用

### コード変更
- [コード変更ワークフロー](./CODE_CHANGE_WORKFLOW.md) - コード変更の承認フロー

---

**最終更新**: 2026-01-12  
**作成者**: AI Assistant  
**承認者**: プロジェクトオーナー