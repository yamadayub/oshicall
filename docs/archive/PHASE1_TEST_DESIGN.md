# Phase 1: テスト設計

## 対象業務仕様

- `/docs/business/video-call.md` の BR-008, BR-009, BR-010

## テストケース一覧

### BR-008: 待機室での入室状態表示ルール

#### TC-008-001: インフルエンサーが先に入室した場合
- **前提条件**: 
  - オークションが落札済み（purchased_slotsが作成済み）
  - 通話開始時刻の15分前以降
- **実行手順**:
  1. インフルエンサーがCallPageにアクセス
  2. インフルエンサーの画面で参加状況を確認
- **期待結果**:
  - インフルエンサー: 待機中
  - ファン: 未入室
- **優先度**: 高

#### TC-008-002: ファンが先に入室した場合
- **前提条件**: 
  - オークションが落札済み（purchased_slotsが作成済み）
  - 通話開始時刻以降
- **実行手順**:
  1. ファンがCallPageにアクセス
  2. ファンの画面で参加状況を確認
- **期待結果**:
  - ファン: 待機中
  - インフルエンサー: 未入室
- **優先度**: 高

#### TC-008-003: 両者がCallPageに入室した場合
- **前提条件**: 
  - オークションが落札済み（purchased_slotsが作成済み）
  - インフルエンサーが15分前からCallPageに入室済み
  - ファンが開始時刻からCallPageに入室済み
- **実行手順**:
  1. 両者の画面で参加状況を確認
- **期待結果**:
  - インフルエンサー: 待機中
  - ファン: 待機中
- **優先度**: 高

#### TC-008-004: 両者がDaily.co接続中の場合
- **前提条件**: 
  - 両者がCallPageに入室済み
  - 両者がDaily.coセッションに接続済み
- **実行手順**:
  1. 両者の画面で参加状況を確認
- **期待結果**:
  - インフルエンサー: 通話中
  - ファン: 通話中
- **優先度**: 高

#### TC-008-005: 片方がDaily.co接続、もう片方が未接続の場合
- **前提条件**: 
  - 両者がCallPageに入室済み
  - インフルエンサーのみDaily.coセッションに接続済み
- **実行手順**:
  1. 両者の画面で参加状況を確認
- **期待結果**:
  - インフルエンサー: 通話中
  - ファン: 待機中
- **優先度**: 中

### BR-009: インフルエンサーの入室タイミング

#### TC-009-001: 15分前にCallPage入室可能
- **前提条件**: 
  - オークションが落札済み（purchased_slotsが作成済み）
  - 通話開始時刻の15分前
- **実行手順**:
  1. インフルエンサーがCallPageにアクセス
- **期待結果**:
  - CallPageが表示される
  - 待機画面が表示される
- **優先度**: 高

#### TC-009-002: 15分前にDaily.co接続可能
- **前提条件**: 
  - オークションが落札済み（purchased_slotsが作成済み）
  - 通話開始時刻の15分前
  - インフルエンサーがCallPageに入室済み
- **実行手順**:
  1. インフルエンサーが「通話を開始する」ボタンをクリック
  2. Daily.coセッションへの接続を試みる
- **期待結果**:
  - Daily.coセッションに接続できる
  - ビデオ通話画面が表示される
- **優先度**: 高

#### TC-009-003: 16分前はDaily.co接続不可
- **前提条件**: 
  - オークションが落札済み（purchased_slotsが作成済み）
  - 通話開始時刻の16分前
  - インフルエンサーがCallPageに入室済み
- **実行手順**:
  1. インフルエンサーが「通話を開始する」ボタンをクリック
  2. Daily.coセッションへの接続を試みる
- **期待結果**:
  - Daily.coセッションに接続できない
  - エラーメッセージが表示される（またはボタンが無効化されている）
- **優先度**: 中

#### TC-009-004: ちょうど15分前（エッジケース）
- **前提条件**: 
  - オークションが落札済み（purchased_slotsが作成済み）
  - 通話開始時刻のちょうど15分前（秒単位で一致）
  - インフルエンサーがCallPageに入室済み
- **実行手順**:
  1. インフルエンサーが「通話を開始する」ボタンをクリック
  2. Daily.coセッションへの接続を試みる
- **期待結果**:
  - Daily.coセッションに接続できる
- **優先度**: 中

#### TC-009-005: 開始時刻の30分後まで入室可能
- **前提条件**: 
  - オークションが落札済み（purchased_slotsが作成済み）
  - 通話開始時刻の30分後
- **実行手順**:
  1. インフルエンサーがCallPageにアクセス
- **期待結果**:
  - CallPageが表示される
- **優先度**: 低

### BR-010: ファンの入室タイミング

#### TC-010-001: 開始前にCallPage入室可能（待機画面表示）
- **前提条件**: 
  - オークションが落札済み（purchased_slotsが作成済み）
  - 通話開始時刻の前（例: 1時間前）
- **実行手順**:
  1. ファンがCallPageにアクセス
- **期待結果**:
  - CallPageが表示される
  - 待機画面が表示される
  - カウントダウンタイマーが表示される
- **優先度**: 高

#### TC-010-002: 開始時刻に自動でDaily.co接続
- **前提条件**: 
  - オークションが落札済み（purchased_slotsが作成済み）
  - ファンがCallPageに入室済み
  - 通話開始時刻になった
- **実行手順**:
  1. 通話開始時刻を待つ
  2. 自動接続の動作を確認
- **期待結果**:
  - 通話開始時刻になると自動的にDaily.coセッションに接続される
  - ビデオ通話画面が表示される
- **優先度**: 高

#### TC-010-003: 開始後はDaily.co接続済み
- **前提条件**: 
  - オークションが落札済み（purchased_slotsが作成済み）
  - 通話開始時刻の後（例: 5分後）
  - ファンがCallPageに入室済み
- **実行手順**:
  1. ファンがCallPageにアクセス
  2. 「通話を開始する」ボタンをクリック
- **期待結果**:
  - Daily.coセッションに接続できる
  - ビデオ通話画面が表示される
- **優先度**: 高

#### TC-010-004: ちょうど開始時刻（エッジケース）
- **前提条件**: 
  - オークションが落札済み（purchased_slotsが作成済み）
  - ファンがCallPageに入室済み
  - 通話開始時刻のちょうど（秒単位で一致）
- **実行手順**:
  1. 通話開始時刻を待つ
  2. 自動接続の動作を確認
- **期待結果**:
  - 通話開始時刻になると自動的にDaily.coセッションに接続される
- **優先度**: 中

#### TC-010-005: 開始時刻の30分後まで入室可能
- **前提条件**: 
  - オークションが落札済み（purchased_slotsが作成済み）
  - 通話開始時刻の30分後
- **実行手順**:
  1. ファンがCallPageにアクセス
- **期待結果**:
  - CallPageが表示される
- **優先度**: 低

## テスト実装方針

### E2Eテスト
- Playwrightを使用
- 2つのブラウザコンテキストを使用してインフルエンサーとファンを同時にシミュレート
- 時刻のモックは使用せず、実際の時刻を使用（テストデータの通話開始時刻を調整）

### テストデータ準備
- テスト用のオークション落札データを作成
- 通話開始時刻を現在時刻から適切な時間に設定

### アサーション
- 画面の表示内容を確認（参加状況の表示）
- Daily.coセッションへの接続状態を確認
- APIレスポンスの内容を確認

---

**作成日**: 2025-01-XX

