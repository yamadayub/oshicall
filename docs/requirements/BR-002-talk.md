# BR-002: Talk（通話）機能

## 概要

インフルエンサーとファンが1対1でビデオ通話を実施する機能。オークション落札後、予定時刻にDaily.coを使用した高品質ビデオ通話を提供します。通話の正常完了を自動判定し、公平な決済処理を実現します。

**ビジネス価値**:
- ファンは憧れのインフルエンサーと直接コミュニケーションできる
- インフルエンサーはファンとの関係を深め、収益を得られる
- プラットフォームは高品質な通話体験により信頼性を確保

## ユーザーストーリー

### US-001: Talk枠作成（インフルエンサー視点）
```
As a インフルエンサー,
I want to Talk枠（通話枠）を作成してオークションに出品する,
So that ファンとの通話で収益を得られる
```

### US-002: Talk枠一覧閲覧（ファン視点）
```
As a ファン,
I want to 開催中のTalk枠一覧を閲覧する,
So that 興味のあるインフルエンサーのTalkを見つけられる
```

### US-003: Talk予定確認（ファン視点）
```
As a ファン,
I want to 落札したTalkの予定を確認する,
So that 通話時刻を忘れずに参加できる
```

### US-004: ビデオ通話実施（ファン・インフルエンサー共通）
```
As a ユーザー（ファン/インフルエンサー）,
I want to 予定時刻に高品質なビデオ通話を実施する,
So that スムーズにコミュニケーションできる
```

### US-005: Talk完了確認（システム）
```
As a システム,
I want to Talkが正常に完了したかを自動判定する,
So that 公平な決済処理を実現できる
```

## 機能要件

### FR-001: Talk枠作成
**説明**: インフルエンサーがTalk枠を作成し、オークションに出品できる

**受け入れ条件**:
- [ ] インフルエンサーのみTalk枠を作成できる
- [ ] タイトル（必須）を入力できる
- [ ] 説明（必須）を入力できる
- [ ] 通話開始予定時刻（必須、未来の日時）を設定できる
- [ ] 通話時間（デフォルト: 30分）を設定できる
- [ ] サムネイル画像（任意）をアップロードできる
- [ ] 開始価格（デフォルト: 1,000円）を設定できる
- [ ] 即決価格（任意）を設定できる
- [ ] バリデーションエラーが適切に表示される
- [ ] 作成成功時にダッシュボードへリダイレクトされる

**関連ファイル**:
- 実装: `src/components/CreateCallSlotForm.tsx`
- API: Supabase直接操作 (call_slotsテーブル)
- 技術仕様: [/docs/functional/functions/talk.md#1-talk枠作成](../functional/functions/talk.md)

---

### FR-002: Talk枠一覧表示
**説明**: Topページで開催中のTalk枠一覧が優先順位付きで表示される

**受け入れ条件**:
- [ ] オークション開催中（active）の枠が優先表示される
- [ ] フォロー中のインフルエンサーの枠が優先表示される
- [ ] オークション終了時刻が近い順にソートされる
- [ ] サムネイル画像が表示される
- [ ] インフルエンサー名・アバターが表示される
- [ ] 現在の最高入札額が表示される
- [ ] カウントダウンタイマーが表示される
- [ ] Talk枠カードをクリックで詳細ページに遷移する

**ソート優先順位**:
1. オークション開催中 > 終了済み
2. フォロー中 > 未フォロー
3. 終了時刻が近い順

**関連ファイル**:
- 実装: `src/pages/Home.tsx`
- コンポーネント: `src/components/TalkCard.tsx`
- データソース: `active_auctions_view`
- 技術仕様: [/docs/functional/functions/talk.md#2-talk枠一覧表示](../functional/functions/talk.md)

---

### FR-003: Talk枠詳細表示
**説明**: Talk枠の詳細情報とオークション情報を表示

**受け入れ条件**:
- [ ] 背景画像（detail_image_url）が表示される
- [ ] インフルエンサー情報（名前、アバター、プロフィール）が表示される
- [ ] Talk予定時間が日本時間で表示される
- [ ] ホストメッセージが表示される
- [ ] 現在の最高入札額が表示される
- [ ] 入札ボタンが機能する
- [ ] 即決購入ボタン（設定がある場合）が機能する
- [ ] カウントダウンタイマーがリアルタイム更新される
- [ ] インフルエンサー名クリックでインフルエンサーページに遷移する

**関連ファイル**:
- 実装: `src/pages/TalkDetail.tsx`
- 技術仕様: [/docs/functional/functions/talk.md#3-talk枠詳細表示](../functional/functions/talk.md)

---

### FR-004: 購入済みTalk一覧
**説明**: ファンが落札したTalk枠の一覧をマイページで確認できる

**受け入れ条件**:
- [ ] 落札したTalk枠が一覧表示される
- [ ] Talk予定時刻順（新しい順）にソートされる
- [ ] インフルエンサー情報が表示される
- [ ] 通話ステータス（upcoming/ready/completed）が表示される
- [ ] 通話可能時間（予定時刻の前後30分）に「通話開始」ボタンが表示される
- [ ] 「通話開始」ボタンクリックで通話ページに遷移する

**ステータス定義**:
- `upcoming`: 予定時刻の30分以上前
- `ready`: 予定時刻の前後30分以内（通話可能）
- `completed`: 通話完了

**関連ファイル**:
- 実装: `src/pages/MyPage.tsx` (Talksタブ)
- データソース: `purchased_slots`
- 技術仕様: [/docs/functional/functions/talk.md#4-購入済みtalk一覧](../functional/functions/talk.md)

---

### FR-005: ビデオ通話実施
**説明**: 予定時刻にDaily.coを使用した高品質ビデオ通話を実施

**受け入れ条件**:
- [ ] 購入済みTalk枠のみアクセスできる
- [ ] 予定時刻の前後30分以内のみアクセスできる
- [ ] Daily.coルームが自動作成される
- [ ] インフルエンサーは開始時刻前（15分前から）に入室して待機できる
- [ ] ビデオ・音声が正常に動作する
- [ ] 画面共有機能が利用できる
- [ ] 通話時間が画面に表示される
- [ ] 規定時間経過で自動終了する
- [ ] 手動終了ボタンが機能する
- [ ] 途中退室時に警告モーダルが表示される
  - インフルエンサー: 「途中退室すると落札がキャンセルされ、入金されませんが退室されますか？」
  - ファン: 「途中退室しても落札はキャンセルされず、課金されますが退室されますか？」
- [ ] 時間切れ（残り時間0）の場合は警告なしで終了する

**関連ファイル**:
- 実装: `src/pages/CallPage.tsx`, `src/pages/LiveTalk.tsx`
- バックエンド: `backend/src/routes/calls.ts`
- 技術仕様: [/docs/functional/functions/talk.md#5-ビデオ通話実施](../functional/functions/talk.md)

---

### FR-006: Daily.co Webhook受信
**説明**: Daily.coからの通話イベントを受信し、データベースに記録

**受け入れ条件**:
- [ ] `participant.joined` イベントを受信・記録できる
- [ ] `participant.left` イベントを受信・記録できる
- [ ] `room.ended` イベントを受信・記録できる
- [ ] `meeting.ended` イベントを受信・記録できる
- [ ] イベントデータが`daily_call_events`テーブルに保存される
- [ ] Webhook認証（HMAC）が検証される
- [ ] イベント受信後、即座に200レスポンスを返す

**関連ファイル**:
- 実装: `backend/src/routes/dailyWebhook.ts`
- データベース: `daily_call_events`テーブル
- 技術仕様: [/docs/functional/ADVANCED_PAYMENT_FLOW.md#2-dailyco-webhook受信](../functional/ADVANCED_PAYMENT_FLOW.md)

---

### FR-007: Talk完了判定
**説明**: Daily.coイベントログを分析し、Talkが正常に完了したかを自動判定

**受け入れ条件**:
- [ ] インフルエンサーが参加したことを確認できる
- [ ] ルームが規定時間経過で自動終了したことを確認できる
- [ ] インフルエンサーが途中退出していないことを確認できる
- [ ] すべての条件を満たす場合、`call_status: 'completed'` に更新される
- [ ] 条件を満たさない場合、`call_status: 'cancelled'` に更新される
- [ ] 判定結果に基づいて決済処理がトリガーされる

**判定条件（すべて満たす必要あり）**:
1. インフルエンサーが参加した (`participant.joined`)
2. ルームが規定時間経過で自動終了した (`room_end_reason: 'duration'`)
3. インフルエンサーが既定時間の最初から最後まで途中退室なしで参加した
   - 開始時刻（`scheduled_start_time`）から終了時刻まで連続参加していること
   - 開始時刻前に入室して待機することは可能
   - 開始時刻から終了時刻までの間に`participant.left`イベントがないこと

**関連ファイル**:
- 実装: `backend/src/services/paymentCapture.ts` (shouldCaptureTalkPayment関数)
- 技術仕様: [/docs/functional/ADVANCED_PAYMENT_FLOW.md#3-talk完了判定ロジック](../functional/ADVANCED_PAYMENT_FLOW.md)

---

### FR-008: Talk完了後の処理
**説明**: Talk完了判定に基づき、適切な後処理を実施

**受け入れ条件**:
- [ ] 正常完了の場合、決済が確定される
- [ ] 正常完了の場合、`purchased_slots.call_status` が `completed` に更新される
- [ ] 正常完了の場合、`call_ended_at` が記録される
- [ ] 不成立の場合、与信が解放される
- [ ] 不成立の場合、`purchased_slots.call_status` が `cancelled` に更新される
- [ ] ユーザー統計（total_calls_completed等）が更新される

**関連ファイル**:
- 実装: `backend/src/services/paymentCapture.ts` (captureTalkPayment関数)
- 技術仕様: [/docs/functional/ADVANCED_PAYMENT_FLOW.md#4-決済確定または与信キャンセル](../functional/ADVANCED_PAYMENT_FLOW.md)

## 非機能要件

### パフォーマンス
- **NFR-001**: Talk枠一覧の初回表示は3秒以内に完了する
- **NFR-002**: ビデオ通話の接続は10秒以内に確立する
- **NFR-003**: 通話品質はHD画質（720p以上）を維持する
- **NFR-004**: Daily.co Webhook受信から200レスポンスまで1秒以内

### セキュリティ
- **NFR-005**: Talk枠作成はインフルエンサーのみ可能（RLS制御）
- **NFR-006**: 通話ページは購入者のみアクセス可能
- **NFR-007**: Daily.coルームURLは推測不可能なランダム文字列
- **NFR-008**: Webhook受信時にHMAC署名を検証する

### ユーザビリティ
- **NFR-009**: Talk予定時刻は日本時間（Asia/Tokyo）で表示される
- **NFR-010**: 通話可能時間（前後30分）が明確に表示される
- **NFR-011**: ビデオ通話UIは直感的で操作しやすい
- **NFR-012**: 通話中の操作ボタン（ミュート等）は大きく押しやすい

### 信頼性
- **NFR-013**: Daily.coルーム作成失敗時はリトライが実行される
- **NFR-014**: Webhook処理失敗時はログが記録され、手動対応可能
- **NFR-015**: 通話中の接続エラーは自動復旧を試みる

## ビジネスルール

### BR-001: Talk枠作成制限
- インフルエンサーのみ作成可能
- 通話開始予定時刻は未来の日時のみ
- 通話時間は最低5分以上

### BR-002: 通話アクセス制限
- 購入済みTalk枠のみアクセス可能
- 予定時刻の前後30分のみ通話可能
- 通話ステータスが`completed`の場合は再アクセス不可

### BR-003: 時刻表示
- すべて日本時間（Asia/Tokyo）で表示
- フォーマット: `YYYY/MM/DD HH:MM`

### BR-004: Talk完了判定
- インフルエンサー参加必須
- 規定時間経過による自動終了必須
- 途中退出なし必須

### BR-005: 決済タイミング
- Talk正常完了: 決済確定（Capture）
- Talk不成立: 与信解放（Cancel）
- インフルエンサーno-show: 与信解放（Cancel）

## 関連する他の要件

- [BR-001: オークション機能](./BR-001-auction.md) - Talk枠のオークション出品
- [BR-003: 決済機能](./BR-003-payment.md) - Talk完了後の決済確定
- [BR-005: インフルエンサー管理](./BR-005-influencer.md) - Talk枠作成フォーム

## 変更履歴

| 日付 | 変更内容 | 理由 |
|------|----------|------|
| 2025-12-10 | 初回作成 | 業務要件ドキュメントの整備 |

## 備考

### 将来実装予定
- Talk録画機能（録画データの保存・再生）
- テキストチャット（通話中のチャット機能）
- レビュー・評価機能（Talk後の評価投稿）
- リマインダー通知（Talk開始30分前のプッシュ通知）
- カレンダー連携（Google Calendar等への予定追加）

### 既知の制約
- Daily.co無料プランは通話時間に制限あり
- ビデオ通話はWebRTC対応ブラウザのみ（IE非対応）
- 通話可能時間は予定時刻の前後30分のみ
