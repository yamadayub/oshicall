# BR-005: インフルエンサー管理機能

## 概要

インフルエンサーがTalk枠を作成・管理し、売上を確認できる専用ダッシュボード機能。インフルエンサーとしての活動を効率的に管理し、収益化を支援します。

**ビジネス価値**:
- インフルエンサーは簡単にTalk枠を出品し、収益を得られる
- ダッシュボードで売上・予定を一元管理できる
- ファンからの需要を可視化し、戦略的に活動できる

## ユーザーストーリー

### US-001: Talk枠作成（インフルエンサー視点）
```
As a インフルエンサー,
I want to Talk枠を簡単に作成する,
So that ファンに通話機会を提供し、収益を得られる
```

### US-002: ダッシュボード閲覧（インフルエンサー視点）
```
As a インフルエンサー,
I want to 自分のTalk枠一覧と売上を一画面で確認する,
So that 活動状況を把握できる
```

### US-003: 売上確認（インフルエンサー視点）
```
As a インフルエンサー,
I want to 完了したTalkの売上を確認する,
So that 収益状況を把握できる
```

### US-004: スケジュール管理（インフルエンサー視点）
```
As a インフルエンサー,
I want to 予定されているTalkのスケジュールを確認する,
So that Talk時刻を忘れずに参加できる
```

### US-005: インフルエンサーページ閲覧（ファン視点）
```
As a ファン,
I want to 特定のインフルエンサーのページを閲覧する,
So that そのインフルエンサーの情報やTalk枠を確認できる
```

## 機能要件

### FR-001: インフルエンサーダッシュボード表示
**説明**: インフルエンサー専用のダッシュボードページを提供

**受け入れ条件**:
- [ ] `/influencer-dashboard` でアクセスできる
- [ ] インフルエンサーのみアクセスできる（`is_influencer` チェック）
- [ ] 作成したTalk枠一覧が表示される
- [ ] 各Talk枠のステータス（オークション中/終了）が表示される
- [ ] 現在の最高入札額が表示される
- [ ] オークション終了までの残り時間が表示される
- [ ] Talk予定時刻が表示される
- [ ] 「Talk枠を作成」ボタンが表示される

**関連ファイル**:
- 実装: `src/pages/InfluencerDashboard.tsx`
- 技術仕様: [/docs/functional/functions/influencer.md#1-インフルエンサーダッシュボード](../functional/functions/influencer.md)

---

### FR-002: Talk枠作成フォーム
**説明**: インフルエンサーが新しいTalk枠を作成できるフォームを提供

**受け入れ条件**:
- [ ] タイトル入力フィールドが表示される（必須）
- [ ] 説明入力フィールドが表示される（必須）
- [ ] 通話開始予定時刻選択フィールドが表示される（必須）
- [ ] 通話時間選択フィールドが表示される（デフォルト: 30分）
- [ ] サムネイル画像アップロードフィールドが表示される（任意）
- [ ] 開始価格入力フィールドが表示される（デフォルト: 1,000円）
- [ ] 即決価格入力フィールドが表示される（任意）
- [ ] 「作成」ボタンクリックで作成処理が実行される
- [ ] バリデーションエラーが適切に表示される
- [ ] 作成成功時にダッシュボードにリダイレクトされる

**バリデーション**:
- タイトル: 1文字以上
- 説明: 1文字以上
- 通話開始時刻: 未来の日時
- 通話時間: 5分以上
- 開始価格: 100円以上
- 即決価格: 開始価格より高い（設定する場合）

**関連ファイル**:
- 実装: `src/components/CreateCallSlotForm.tsx`
- 技術仕様: [/docs/functional/functions/influencer.md#2-talk枠作成フォーム](../functional/functions/influencer.md)

---

### FR-003: サムネイル画像アップロード
**説明**: Talk枠のサムネイル画像をアップロードできる

**受け入れ条件**:
- [ ] 画像選択ボタンが表示される
- [ ] ファイル選択ダイアログが開く
- [ ] プレビュー画像が表示される
- [ ] 画像サイズが制限される（最大1MB）
- [ ] 画像形式が制限される（JPEG, PNG, WebP）
- [ ] Supabase Storageにアップロードされる
- [ ] 公開URLが生成される
- [ ] `call_slots.thumbnail_url` に保存される
- [ ] アップロード失敗時にエラーメッセージが表示される

**関連ファイル**:
- 実装: `src/components/CreateCallSlotForm.tsx`
- ストレージ: Supabase Storage (`talk-thumbnails` バケット)
- 技術仕様: [/docs/functional/functions/influencer.md#画像アップロード](../functional/functions/influencer.md)

---

### FR-004: Talk枠一覧表示（ダッシュボード）
**説明**: インフルエンサーが作成したTalk枠の一覧を表示

**受け入れ条件**:
- [ ] 自分が作成したTalk枠のみ表示される
- [ ] Talk予定時刻順（新しい順）にソートされる
- [ ] サムネイル画像が表示される
- [ ] タイトルが表示される
- [ ] 通話予定時刻が表示される
- [ ] オークション終了時刻が表示される
- [ ] 現在の最高入札額が表示される
- [ ] ステータスバッジが表示される（active/ended）
- [ ] Talk枠カードクリックで詳細ページに遷移する

**関連ファイル**:
- 実装: `src/pages/InfluencerDashboard.tsx`
- データ取得: `call_slots` + `auctions` JOIN
- 技術仕様: [/docs/functional/functions/influencer.md#1-インフルエンサーダッシュボード](../functional/functions/influencer.md)

---

### FR-005: 売上管理
**説明**: インフルエンサーが総売上額と完了Talk数を確認できる

**受け入れ条件**:
- [ ] 総売上額が表示される
- [ ] 完了したTalk件数が表示される
- [ ] 平均評価が表示される（将来実装）
- [ ] 売上情報がリアルタイムで更新される
- [ ] 売上データが正確に集計される

**関連ファイル**:
- 実装: `src/pages/InfluencerDashboard.tsx`
- データソース: `purchased_slots`, `call_slots`
- 統計: `users.total_earned`, `users.total_calls_completed`
- 技術仕様: [/docs/functional/functions/influencer.md#5-売上管理](../functional/functions/influencer.md)

---

### FR-006: スケジュール管理
**説明**: インフルエンサーが予定されているTalk一覧を確認できる

**受け入れ条件**:
- [ ] 予定されているTalk一覧が表示される
- [ ] 日時順（新しい順）にソートされる
- [ ] ファン名が表示される
- [ ] Talk予定時刻が表示される
- [ ] ステータス（upcoming/ready/in_progress/completed）が表示される
- [ ] 通話開始ボタン（ready状態の場合）が表示される

**関連ファイル**:
- 実装: `src/pages/InfluencerDashboard.tsx`
- データソース: `purchased_slots` + `call_slots`
- 技術仕様: [/docs/functional/functions/influencer.md#6-スケジュール管理](../functional/functions/influencer.md)

---

### FR-007: インフルエンサーページ表示
**説明**: ファンが特定のインフルエンサーの情報とTalk枠を閲覧できる公開ページ

**受け入れ条件**:
- [ ] `/i/{influencer_id}` でアクセスできる
- [ ] インフルエンサー情報（名前、画像、自己紹介）が表示される
- [ ] フォローボタンが表示される
- [ ] 統計情報（完了Talk数、平均評価、フォロワー数）が表示される
- [ ] 開催中のTalk枠一覧が表示される
- [ ] 過去のTalk枠が表示される（将来実装）
- [ ] インフルエンサーが存在しない場合、404エラーが表示される

**関連ファイル**:
- 実装: `src/pages/InfluencerPage.tsx`
- データ取得: `users`, `active_auctions_view`
- 技術仕様: [/docs/functional/functions/influencer.md#インフルエンサー詳細ページ](../functional/functions/influencer.md)

---

### FR-008: Talk枠編集（将来実装）
**説明**: インフルエンサーが作成済みのTalk枠を編集できる

**受け入れ条件**:
- [ ] ダッシュボードから「編集」ボタンが表示される
- [ ] タイトル・説明を修正できる
- [ ] 画像を変更できる
- [ ] 通話時刻を変更できる（オークション開始前のみ）
- [ ] 価格を変更できる（入札がない場合のみ）
- [ ] オークション開始後は編集不可
- [ ] 入札がある場合は価格変更不可

**関連ファイル**:
- 実装: 将来実装予定
- 技術仕様: [/docs/functional/functions/influencer.md#3-talk枠編集](../functional/functions/influencer.md)

---

### FR-009: Talk枠削除（将来実装）
**説明**: インフルエンサーが作成済みのTalk枠を削除できる

**受け入れ条件**:
- [ ] ダッシュボードから「削除」ボタンが表示される
- [ ] 確認ダイアログが表示される
- [ ] 削除実行後、Talk枠が一覧から消える
- [ ] 入札がない場合のみ削除可能
- [ ] オークション開始後は削除不可

**関連ファイル**:
- 実装: 将来実装予定
- 技術仕様: [/docs/functional/functions/influencer.md#4-talk枠削除](../functional/functions/influencer.md)

## 非機能要件

### セキュリティ
- **NFR-001**: ダッシュボードはインフルエンサーのみアクセス可能（`is_influencer` チェック）
- **NFR-002**: Talk枠の作成・編集・削除は作成者のみ可能（RLS制御）
- **NFR-003**: サムネイル画像のアップロードサイズ制限（最大1MB）
- **NFR-004**: 画像ファイル形式の検証（JPEG, PNG, WebP）

### パフォーマンス
- **NFR-005**: ダッシュボードの初回表示は3秒以内に完了する
- **NFR-006**: Talk枠作成処理は5秒以内に完了する
- **NFR-007**: 画像アップロードは5秒以内に完了する（1MB以下の場合）
- **NFR-008**: 売上情報の集計は2秒以内に完了する

### ユーザビリティ
- **NFR-009**: Talk枠作成フォームは直感的で入力しやすい
- **NFR-010**: バリデーションエラーは具体的でわかりやすい
- **NFR-011**: ダッシュボードのレイアウトは見やすく整理されている
- **NFR-012**: 統計情報は視覚的にわかりやすく表示される

### 信頼性
- **NFR-013**: Talk枠作成失敗時はロールバックされる
- **NFR-014**: 画像アップロード失敗時はエラーログが記録される
- **NFR-015**: 売上集計エラー時は再試行が実行される

## ビジネスルール

### BR-001: インフルエンサー判定
- `users.is_influencer` が `true` のユーザーのみインフルエンサー機能にアクセス可能
- 将来: インフルエンサー申請・承認フローの実装

### BR-002: Talk枠作成制限
- 通話開始予定時刻は未来の日時のみ
- 通話時間は最低5分以上
- 開始価格は100円以上
- 即決価格は開始価格より高く設定

### BR-003: オークション自動作成
- Talk枠作成時に自動的にオークションが作成される
- オークション終了時刻は通話開始時刻の1時間前に設定される
- 最小オークション期間は1時間（推奨）

### BR-004: 編集・削除制限
- オークション開始後は編集・削除不可
- 入札がある場合は価格変更不可
- 入札がある場合は削除不可

### BR-005: 売上計算
- 総売上額 = 完了したTalkの落札額の合計
- プラットフォーム手数料控除後の金額（将来実装）
- リアルタイム更新または定期バッチ集計

## 関連する他の要件

- [BR-001: オークション機能](./BR-001-auction.md) - Talk枠のオークション出品
- [BR-002: Talk機能](./BR-002-talk.md) - Talk枠作成とTalk実施
- [BR-006: フォロー機能](./BR-006-follow.md) - インフルエンサーページのフォローボタン

## 変更履歴

| 日付 | 変更内容 | 理由 |
|------|----------|------|
| 2025-12-10 | 初回作成 | 業務要件ドキュメントの整備 |

## 備考

### 将来実装予定
- カレンダービュー（月別カレンダー表示）
- レビュー管理（Talk後のレビュー閲覧・返信）
- 売上分析（月別売上グラフ、人気時間帯分析）
- 通知機能（オークション終了通知、Talk開始時刻通知、新規フォロワー通知）
- インフルエンサー申請・承認フロー
- Talk枠テンプレート機能
- 一括Talk枠作成機能

### 既知の制約
- Talk枠の編集・削除は未実装
- カレンダービューは未実装
- 売上分析グラフは未実装
- 月別売上データは未実装

### セキュリティ対策
- RLS (Row Level Security) ポリシー:
  ```sql
  CREATE POLICY "Users can update own call slots"
  ON call_slots
  FOR UPDATE
  USING (auth.uid() = user_id);

  CREATE POLICY "Users can delete own call slots"
  ON call_slots
  FOR DELETE
  USING (auth.uid() = user_id);
  ```
- インフルエンサー権限チェック
- 画像アップロード時のファイル検証
