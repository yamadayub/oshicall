# BR-004: ユーザー認証機能

## 概要

Supabase Authを使用したユーザー認証システム。Google OAuthによるソーシャルログインを提供し、安全かつスムーズなユーザー登録・ログイン体験を実現します。

**ビジネス価値**:
- ユーザーは簡単にアカウントを作成し、サービスを利用開始できる
- セキュアな認証により、ユーザーデータを保護できる
- OAuth連携により、パスワード管理の負担を軽減できる

## ユーザーストーリー

### US-001: Google OAuth ログイン（ファン/インフルエンサー共通）
```
As a ユーザー,
I want to Googleアカウントでログインする,
So that パスワードを覚えなくても簡単にログインできる
```

### US-002: プロフィール管理（ファン/インフルエンサー共通）
```
As a ユーザー,
I want to プロフィール情報（名前、自己紹介、画像）を編集する,
So that 自分を他のユーザーに適切にアピールできる
```

### US-003: ログアウト（ファン/インフルエンサー共通）
```
As a ユーザー,
I want to 安全にログアウトする,
So that 他の人に自分のアカウントを使われないようにできる
```

### US-004: 認証状態の維持（ファン/インフルエンサー共通）
```
As a ユーザー,
I want to ページを再読み込みしてもログイン状態を維持する,
So that 毎回ログインする手間を省ける
```

## 機能要件

### FR-001: Google OAuth ログイン
**説明**: ユーザーがGoogleアカウントでログイン・新規登録できる

**受け入れ条件**:
- [ ] 「Googleでログイン」ボタンが表示される
- [ ] ボタンクリックでGoogleログイン画面に遷移する
- [ ] Googleアカウント選択画面が表示される
- [ ] アカウント選択後、OshiTalkにリダイレクトされる
- [ ] 初回ログイン時に `users` テーブルにレコードが作成される
- [ ] ユーザー名・メールアドレス・プロフィール画像が自動設定される
- [ ] ログイン成功時に元のページに戻る
- [ ] ログイン失敗時にエラーメッセージが表示される

**関連ファイル**:
- 実装: `src/lib/auth.ts` (signInWithGoogle関数)
- コンポーネント: `src/components/AuthModal.tsx`
- 技術仕様: [/docs/functional/functions/authentication.md#2-google-oauth認証](../functional/functions/authentication.md)

---

### FR-002: セッション管理
**説明**: ログイン状態をセッションとして管理し、ページ遷移後も維持

**受け入れ条件**:
- [ ] ログイン後、JWTトークンがブラウザに保存される
- [ ] ページリロード後もログイン状態が維持される
- [ ] AuthContextが全コンポーネントでログイン状態を提供する
- [ ] `user`（Supabase Auth User）が提供される
- [ ] `supabaseUser`（usersテーブルのユーザー情報）が提供される
- [ ] セッション有効期限は1時間（自動更新）
- [ ] セッション切れ時に自動的にログアウトする

**関連ファイル**:
- 実装: `src/contexts/AuthContext.tsx`
- 技術仕様: [/docs/functional/functions/authentication.md#セッション管理](../functional/functions/authentication.md)

---

### FR-003: ログアウト
**説明**: ユーザーが安全にログアウトできる

**受け入れ条件**:
- [ ] ヘッダーに「ログアウト」ボタンが表示される
- [ ] ボタンクリックでログアウト処理が実行される
- [ ] Supabaseセッションが削除される
- [ ] ローカル状態がクリアされる
- [ ] トップページにリダイレクトされる
- [ ] ログアウト後は保護されたページにアクセスできない

**関連ファイル**:
- 実装: `src/lib/auth.ts`, `src/components/Layout.tsx`
- 技術仕様: [/docs/functional/functions/authentication.md#ログアウト](../functional/functions/authentication.md)

---

### FR-004: プロフィール編集
**説明**: ユーザーがプロフィール情報を編集できる

**受け入れ条件**:
- [ ] マイページに「プロフィール」タブが表示される
- [ ] 表示名（display_name）を編集できる
- [ ] 自己紹介（bio）を編集できる
- [ ] プロフィール画像をアップロードできる
- [ ] 画像サイズが制限される（最大1MB）
- [ ] 画像形式が制限される（JPEG, PNG, WebP）
- [ ] 「保存」ボタンクリックで更新される
- [ ] 更新成功時に確認メッセージが表示される
- [ ] 更新失敗時にエラーメッセージが表示される

**関連ファイル**:
- 実装: `src/pages/MyPage.tsx` (Profileタブ)
- ストレージ: Supabase Storage (`avatars` バケット)
- 技術仕様: [/docs/functional/functions/authentication.md#プロフィール管理](../functional/functions/authentication.md)

---

### FR-005: プロフィール画像アップロード
**説明**: ユーザーがプロフィール画像をアップロード・変更できる

**受け入れ条件**:
- [ ] 画像選択ボタンが表示される
- [ ] ファイル選択ダイアログが開く
- [ ] プレビュー画像が表示される
- [ ] Supabase Storageにアップロードされる
- [ ] 公開URLが生成される
- [ ] `users.profile_image_url` が更新される
- [ ] アップロード失敗時にエラーメッセージが表示される
- [ ] 古い画像は自動的に削除される（将来実装）

**関連ファイル**:
- 実装: `src/pages/MyPage.tsx`
- ストレージ: Supabase Storage (`avatars` バケット)
- 技術仕様: [/docs/functional/functions/authentication.md#ユーザープロフィール更新](../functional/functions/authentication.md)

---

### FR-006: ユーザー情報の自動取得
**説明**: ログイン後、ユーザー情報を自動的に取得・同期

**受け入れ条件**:
- [ ] ログイン直後に `users` テーブルからユーザー情報を取得する
- [ ] 認証状態変更時に自動的に再取得する
- [ ] 取得したユーザー情報が AuthContext で提供される
- [ ] ローディング状態（loading）が提供される
- [ ] エラー時は null が返される

**関連ファイル**:
- 実装: `src/contexts/AuthContext.tsx` (fetchUserFromSupabase関数)
- 技術仕様: [/docs/functional/functions/authentication.md#ユーザー情報取得](../functional/functions/authentication.md)

---

### FR-007: 認証状態による表示切り替え
**説明**: ログイン状態に応じてUIを適切に切り替える

**受け入れ条件**:
- [ ] 未ログイン時は「ログイン」ボタンが表示される
- [ ] ログイン時はユーザーアバター・名前が表示される
- [ ] 未ログイン時は入札ボタンが無効化される
- [ ] 未ログイン時の入札ボタンクリックで認証モーダルが表示される
- [ ] ログイン時はマイページにアクセスできる
- [ ] 未ログイン時のマイページアクセスは認証モーダルが表示される

**関連ファイル**:
- 実装: `src/components/Layout.tsx`, `src/pages/TalkDetail.tsx`
- 技術仕様: [/docs/functional/functions/authentication.md](../functional/functions/authentication.md)

---

### FR-008: 認証モーダル表示
**説明**: 未ログインユーザーが保護された操作を試みた際に認証モーダルを表示

**受け入れ条件**:
- [ ] 未ログイン時の入札ボタンクリックでモーダルが表示される
- [ ] モーダルに「Googleでログイン」ボタンが表示される
- [ ] 「キャンセル」ボタンでモーダルが閉じる
- [ ] ログイン成功後、モーダルが自動的に閉じる
- [ ] ログイン後、元の操作（入札等）が続行される

**関連ファイル**:
- 実装: `src/components/AuthModal.tsx`
- 技術仕様: [/docs/functional/functions/authentication.md#認証モーダル](../functional/functions/authentication.md)

## 非機能要件

### セキュリティ
- **NFR-001**: パスワードはSupabase Authでハッシュ化される
- **NFR-002**: JWTトークンは有効期限付きで発行される
- **NFR-003**: セッショントークンはHttpOnlyクッキーで保存される（将来実装）
- **NFR-004**: OAuth認証はHTTPSで行われる
- **NFR-005**: ユーザーは自分のデータのみ更新できる（RLS制御）

### パフォーマンス
- **NFR-006**: ログイン処理は3秒以内に完了する
- **NFR-007**: プロフィール更新は2秒以内に完了する
- **NFR-008**: 画像アップロードは5秒以内に完了する（1MB以下の場合）

### ユーザビリティ
- **NFR-009**: ログインボタンは明確で見つけやすい
- **NFR-010**: エラーメッセージは具体的でわかりやすい
- **NFR-011**: プロフィール編集フォームは直感的で入力しやすい
- **NFR-012**: 画像プレビューが即座に表示される

### 信頼性
- **NFR-013**: OAuth認証失敗時はリトライが可能
- **NFR-014**: セッション切れ時は自動的にログアウトする
- **NFR-015**: 画像アップロード失敗時はロールバックされる

## ビジネスルール

### BR-001: 認証方式
- 現在: Google OAuthのみサポート
- 将来: メール/パスワード認証も検討

### BR-002: ユーザー情報
- 初回ログイン時に自動的に `users` テーブルにレコードを作成
- `auth.users.id` と `public.users.id` は同一
- メールアドレスは Google から取得

### BR-003: プロフィール画像
- 最大サイズ: 1MB
- 対応形式: JPEG, PNG, WebP
- ストレージ: Supabase Storage (`avatars` バケット)

### BR-004: セッション
- 有効期限: 1時間（自動更新）
- 更新タイミング: ページ遷移時
- 切れた場合: 自動ログアウト

### BR-005: アクセス制御
- 未ログインユーザーは入札不可
- 未ログインユーザーはマイページアクセス不可
- 未ログインユーザーはインフルエンサーダッシュボードアクセス不可

## 関連する他の要件

- [BR-001: オークション機能](./BR-001-auction.md) - ログイン必須
- [BR-003: 決済機能](./BR-003-payment.md) - Stripe顧客作成時にユーザー情報を使用
- [BR-005: インフルエンサー管理](./BR-005-influencer.md) - インフルエンサー判定

## 変更履歴

| 日付 | 変更内容 | 理由 |
|------|----------|------|
| 2025-12-10 | 初回作成 | 業務要件ドキュメントの整備 |

## 備考

### 将来実装予定
- メール/パスワード認証の追加
- パスワードリセット機能
- 2要素認証（2FA）
- ソーシャルログイン追加（GitHub, Twitter等）
- メールアドレス変更機能
- アカウント削除機能

### 既知の制約
- Google OAuthのみサポート（メール/パスワード未実装）
- プロフィール画像は1枚のみ（複数枚未対応）
- セッション有効期限は固定（1時間）

### セキュリティ対策
- RLS (Row Level Security) ポリシー:
  ```sql
  CREATE POLICY "Users can update own profile"
  ON users
  FOR UPDATE
  USING (auth.uid() = id);
  ```
- JWTトークン検証
- HTTPS通信の強制
- CORS設定によるAPI保護
