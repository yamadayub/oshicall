# BR-007: ランキング機能

## 概要

インフルエンサーやTalk枠の人気ランキングを表示し、ユーザーが人気のコンテンツを発見しやすくする機能。ランキングを通じてユーザーエンゲージメントを向上させます。

**実装状況**: ⚠️ 部分実装（総売上ランキングと新着Talk枠のみ実装済み）

**ビジネス価値**:
- ファンは人気のインフルエンサーやTalk枠を簡単に発見できる
- インフルエンサーはランキング上位を目指してモチベーションを高められる
- プラットフォームはユーザーの回遊率・エンゲージメントを向上できる

## ユーザーストーリー

### US-001: インフルエンサーランキング閲覧（ファン視点）
```
As a ファン,
I want to 人気のインフルエンサーをランキング形式で見る,
So that 注目のインフルエンサーを発見できる
```

### US-002: 新着Talk枠閲覧（ファン視点）
```
As a ファン,
I want to 最新のTalk枠を一覧で見る,
So that 見逃さずにチェックできる
```

### US-003: ランキング上位を目指す（インフルエンサー視点）
```
As a インフルエンサー,
I want to 自分のランキング順位を確認する,
So that 活動の成果を実感し、モチベーションを高められる
```

### US-004: 人気Talk枠閲覧（ファン視点・将来実装）
```
As a ファン,
I want to 人気のTalk枠をランキング形式で見る,
So that 話題のTalkに参加できる
```

## 機能要件

### FR-001: インフルエンサーランキング表示（実装済み）
**説明**: 総売上ランキングを表示

**受け入れ条件**:
- [ ] `/rankings` でアクセスできる
- [ ] 「インフルエンサーランキング」タブが表示される
- [ ] 総売上額順にソートされる（降順）
- [ ] 上位10名が表示される
- [ ] 順位が表示される
- [ ] 1位は金メダル🥇、2位は銀メダル🥈、3位は銅メダル🥉が表示される
- [ ] プロフィール画像が表示される
- [ ] インフルエンサー名が表示される
- [ ] 総売上額が表示される
- [ ] 完了Talk数が表示される
- [ ] 平均評価が表示される（将来実装）
- [ ] フォロワー数が表示される（将来実装）

**関連ファイル**:
- 実装: `src/pages/Rankings.tsx`
- データソース: `users` テーブル (`total_earned` 順)
- 技術仕様: [/docs/functional/functions/ranking.md#1-インフルエンサーランキング](../functional/functions/ranking.md)

---

### FR-002: 新着Talk枠表示（実装済み）
**説明**: 最新のTalk枠を作成日時順に表示

**受け入れ条件**:
- [ ] `/rankings` でアクセスできる
- [ ] 「新着Talk枠」タブが表示される
- [ ] 作成日時順（新しい順）にソートされる
- [ ] 上位10件が表示される
- [ ] サムネイル画像が表示される
- [ ] Talk枠タイトルが表示される
- [ ] インフルエンサー名が表示される
- [ ] 現在の最高入札額が表示される
- [ ] オークション終了までの時間が表示される
- [ ] Talk枠カードクリックで詳細ページに遷移する

**関連ファイル**:
- 実装: `src/pages/Rankings.tsx`
- データソース: `active_auctions_view`
- 技術仕様: [/docs/functional/functions/ranking.md#3-新着talk枠](../functional/functions/ranking.md)

---

### FR-003: ランキングタブ切り替え（実装済み）
**説明**: インフルエンサーランキングと新着Talk枠をタブで切り替え

**受け入れ条件**:
- [ ] 「インフルエンサーランキング」タブが表示される
- [ ] 「新着Talk枠」タブが表示される
- [ ] タブクリックで表示が切り替わる
- [ ] アクティブなタブが視覚的に区別される
- [ ] タブ切り替えがスムーズに動作する

**関連ファイル**:
- 実装: `src/pages/Rankings.tsx`
- 技術仕様: [/docs/functional/functions/ranking.md](../functional/functions/ranking.md)

---

### FR-004: ランキングカードデザイン（実装済み）
**説明**: ランキング上位者を特別なデザインで表示

**受け入れ条件**:
- [ ] 1位は金色のグラデーション背景が表示される
- [ ] 2位は銀色のグラデーション背景が表示される
- [ ] 3位は銅色のグラデーション背景が表示される
- [ ] 4位以降は白背景が表示される
- [ ] メダル絵文字（🥇🥈🥉）が表示される
- [ ] カードがホバー時に視覚的なフィードバックがある

**関連ファイル**:
- 実装: `src/pages/Rankings.tsx`
- 技術仕様: [/docs/functional/functions/ranking.md#ランキングカード](../functional/functions/ranking.md)

---

### FR-005: 完了Talk数ランキング（将来実装）
**説明**: Talk完了数順にインフルエンサーをランキング表示

**受け入れ条件**:
- [ ] 「完了Talk数ランキング」タブが表示される
- [ ] `total_calls_completed` 順にソートされる（降順）
- [ ] 上位10名が表示される
- [ ] 完了Talk数が強調表示される
- [ ] 総売上額も併記される

**関連ファイル**:
- 実装: 将来実装予定
- データソース: `users` テーブル (`total_calls_completed` 順)
- 技術仕様: [/docs/functional/functions/ranking.md#1-インフルエンサーランキング](../functional/functions/ranking.md)

---

### FR-006: 平均評価ランキング（将来実装）
**説明**: 平均評価順にインフルエンサーをランキング表示

**受け入れ条件**:
- [ ] 「平均評価ランキング」タブが表示される
- [ ] `average_rating` 順にソートされる（降順）
- [ ] 上位10名が表示される
- [ ] 平均評価が星形式で表示される
- [ ] レビュー数も併記される
- [ ] 最低レビュー数（例: 5件以上）を満たすインフルエンサーのみ表示される

**関連ファイル**:
- 実装: 将来実装予定
- データソース: `users` テーブル (`average_rating` 順)
- 技術仕様: [/docs/functional/functions/ranking.md#1-インフルエンサーランキング](../functional/functions/ranking.md)

---

### FR-007: フォロワー数ランキング（将来実装）
**説明**: フォロワー数順にインフルエンサーをランキング表示

**受け入れ条件**:
- [ ] 「フォロワー数ランキング」タブが表示される
- [ ] `follower_count` 順にソートされる（降順）
- [ ] 上位10名が表示される
- [ ] フォロワー数が強調表示される
- [ ] フォロー増加率も併記される（将来拡張）

**関連ファイル**:
- 実装: 将来実装予定
- データソース: `users` テーブル (`follower_count` 順)
- 技術仕様: [/docs/functional/functions/ranking.md#1-インフルエンサーランキング](../functional/functions/ranking.md)

---

### FR-008: Talk枠人気ランキング（将来実装）
**説明**: 入札数順・最高入札額順・閲覧数順でTalk枠をランキング表示

**受け入れ条件**:
- [ ] 「人気Talk枠」タブが表示される
- [ ] サブタブ（入札数/最高入札額/閲覧数）で切り替えられる
- [ ] 各基準でソートされる
- [ ] 上位10件が表示される
- [ ] 入札数ランキングでは入札数が強調表示される
- [ ] 最高入札額ランキングでは現在価格が強調表示される
- [ ] 閲覧数ランキングでは閲覧数が強調表示される

**関連ファイル**:
- 実装: 将来実装予定
- データソース: `call_slots`, `auctions`, `bids`
- 技術仕様: [/docs/functional/functions/ranking.md#2-talk枠人気ランキング](../functional/functions/ranking.md)

---

### FR-009: ランキング期間フィルター（将来実装）
**説明**: ランキングの集計期間を選択できる

**受け入れ条件**:
- [ ] 期間選択ドロップダウンが表示される
- [ ] 「週間」「月間」「年間」「全期間」を選択できる
- [ ] 期間選択に応じてランキングが更新される
- [ ] 選択した期間が視覚的に明確に表示される
- [ ] デフォルトは「全期間」

**関連ファイル**:
- 実装: 将来実装予定
- 技術仕様: [/docs/functional/functions/ranking.md#4-ランキング期間フィルター](../functional/functions/ranking.md)

---

### FR-010: ランキングキャッシュ（将来実装）
**説明**: ランキングデータをキャッシュし、パフォーマンスを向上

**受け入れ条件**:
- [ ] `ranking_cache` テーブルにランキングデータが保存される
- [ ] 定期的（例: 1日1回）にバッチ処理で更新される
- [ ] キャッシュから高速にランキングを取得できる
- [ ] 計算日時が表示される（例: 「2025-12-10 02:00 時点」）
- [ ] 手動更新ボタンが表示される（管理者のみ）

**関連ファイル**:
- 実装: 将来実装予定
- データベース: `ranking_cache` テーブル
- 技術仕様: [/docs/functional/functions/ranking.md#ランキングキャッシュテーブル](../functional/functions/ranking.md)

## 非機能要件

### パフォーマンス
- **NFR-001**: ランキングページの初回表示は3秒以内に完了する
- **NFR-002**: ランキングデータ取得は2秒以内に完了する
- **NFR-003**: タブ切り替えは0.5秒以内に完了する
- **NFR-004**: ランキングキャッシュ使用時は1秒以内にデータを取得する（将来実装）

### セキュリティ
- **NFR-005**: ランキングデータは全員が閲覧可能
- **NFR-006**: ランキング更新は管理者のみ実行可能（手動更新の場合）
- **NFR-007**: 統計情報の改ざんを防ぐため、集計ロジックはサーバーサイドで実行

### ユーザビリティ
- **NFR-008**: ランキング上位者は視覚的に強調される
- **NFR-009**: メダル絵文字が適切に表示される
- **NFR-010**: ランキングカードは読みやすく整理されている
- **NFR-011**: タブは明確で切り替えやすい

### 信頼性
- **NFR-012**: ランキング集計エラー時は前回のキャッシュを使用する
- **NFR-013**: ランキングデータが存在しない場合はプレースホルダーを表示する
- **NFR-014**: 統計情報の定期検証が実行される

## ビジネスルール

### BR-001: ランキング基準
- **総売上ランキング**: `users.total_earned` の降順
- **完了Talk数ランキング**: `users.total_calls_completed` の降順
- **平均評価ランキング**: `users.average_rating` の降順（最低レビュー数5件以上）
- **フォロワー数ランキング**: `users.follower_count` の降順

### BR-002: ランキング表示件数
- デフォルト: 上位10名/件
- 将来: ページネーションで20件、50件表示も検討

### BR-003: ランキング更新頻度
- 現在: リアルタイム（データベースから直接取得）
- 将来: 1日1回バッチ処理でキャッシュ更新

### BR-004: ランキング期間
- 現在: 全期間のみ
- 将来: 週間、月間、年間、全期間

### BR-005: ランキング順位同率の場合
- 同率の場合は登録日時順（古い順）で並べる

## 関連する他の要件

- [BR-005: インフルエンサー管理](./BR-005-influencer.md) - 売上・統計情報の管理
- [BR-006: フォロー機能](./BR-006-follow.md) - フォロワー数ランキング

## 変更履歴

| 日付 | 変更内容 | 理由 |
|------|----------|------|
| 2025-12-10 | 初回作成 | 業務要件ドキュメントの整備 |

## 備考

### 現在実装済みの機能
- ✅ インフルエンサー総売上ランキング
- ✅ 新着Talk枠一覧
- ✅ ランキングタブ切り替え
- ✅ 上位3名の特別デザイン

### 将来実装予定の機能
- ⚠️ 完了Talk数ランキング
- ⚠️ 平均評価ランキング
- ⚠️ フォロワー数ランキング
- ⚠️ Talk枠人気ランキング（入札数/最高入札額/閲覧数）
- ⚠️ ランキング期間フィルター（週間/月間/年間/全期間）
- ⚠️ ランキングキャッシュ（パフォーマンス向上）
- ⚠️ ランキング推移グラフ
- ⚠️ 急上昇インフルエンサー
- ⚠️ ランキングエクスポート（CSV/PDF）

### 既知の制約
- ランキングはリアルタイム集計（キャッシュ未実装）
- 期間フィルターは未実装（全期間のみ）
- Talk枠人気ランキングは未実装
- ランキング推移は未実装

### パフォーマンス最適化案
- **インデックス活用**: `users.total_earned`, `users.total_calls_completed` にインデックス作成
- **キャッシング**: `ranking_cache` テーブルで事前集計
- **バッチ処理**: 深夜バッチで統計情報更新
- **Redis**: 高速キャッシュ層の導入（将来検討）

### 統計情報更新方法
現在: Talk完了時に手動更新（将来はトリガーまたはバッチ）
```sql
-- 総売上の集計
UPDATE users
SET total_earned = (
  SELECT COALESCE(SUM(ps.final_price), 0)
  FROM purchased_slots ps
  JOIN call_slots cs ON ps.call_slot_id = cs.id
  WHERE cs.user_id = users.id
);

-- 完了Talk数の集計
UPDATE users
SET total_calls_completed = (
  SELECT COUNT(*)
  FROM purchased_slots ps
  JOIN call_slots cs ON ps.call_slot_id = cs.id
  WHERE cs.user_id = users.id
    AND ps.call_status = 'completed'
);
```
