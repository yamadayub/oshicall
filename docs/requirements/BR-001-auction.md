# BR-001: オークション機能

## 概要

インフルエンサーが提供するTalk枠（通話枠）を、ファンがオークション形式で購入できる機能。リアルタイム入札と即決購入の2つの購入方式を提供し、公平かつスムーズな価格決定を実現します。

**ビジネス価値**:
- ファンは市場価格でTalk枠を購入できる
- インフルエンサーは需要に応じた適正価格で販売できる
- プラットフォームは競争的な価格設定により収益を最大化

## ユーザーストーリー

### US-001: リアルタイム入札（ファン視点）
```
As a ファン,
I want to 気に入ったTalk枠に入札する,
So that 希望価格で落札のチャンスを得られる
```

### US-002: 即決購入（ファン視点）
```
As a ファン,
I want to オークションを待たずに即座に購入する,
So that 確実にTalk枠を獲得できる
```

### US-003: オークション作成（インフルエンサー視点）
```
As a インフルエンサー,
I want to Talk枠をオークション形式で出品する,
So that 適正な市場価格で販売できる
```

### US-004: リアルタイム更新（ファン視点）
```
As a ファン,
I want to 最高入札額と残り時間をリアルタイムで確認する,
So that 戦略的に入札できる
```

## 機能要件

### FR-001: オークション作成
**説明**: インフルエンサーがTalk枠に対してオークションを設定できる

**受け入れ条件**:
- [ ] Talk枠作成時に自動的にオークションが作成される
- [ ] 開始価格（最低入札価格）を設定できる
- [ ] 最小入札単位を設定できる（デフォルト: 100円）
- [ ] 即決価格（任意）を設定できる
- [ ] オークション終了時刻はTalk開始時刻の1時間前に自動設定される
- [ ] 開始価格は100円以上でなければならない
- [ ] 即決価格がある場合、開始価格より高くなければならない

**関連ファイル**:
- 実装: `src/components/CreateCallSlotForm.tsx`
- API: `backend/src/routes/auctions.ts`
- 技術仕様: [/docs/functional/functions/auction.md](../functional/functions/auction.md)

---

### FR-002: リアルタイム入札
**説明**: ファンがオークション開催中のTalk枠に入札できる

**受け入れ条件**:
- [ ] ログイン済みユーザーのみ入札できる
- [ ] カード登録済みユーザーのみ入札できる
- [ ] 現在の最高入札額より高い金額のみ受け付ける
- [ ] 入札時に与信確保（Authorization）が成功する
- [ ] クイック入札ボタン（+10円, +100円, +1,000円）が機能する
- [ ] カスタム金額入力による入札が機能する
- [ ] 入札成功時に確認メッセージが表示される
- [ ] 入札失敗時にエラーメッセージが表示される

**関連ファイル**:
- 実装: `src/pages/TalkDetail.tsx` (handleBid関数)
- API: `POST /api/stripe/authorize-payment`
- 技術仕様: [/docs/functional/functions/auction.md#2-通常入札](../functional/functions/auction.md)

---

### FR-003: 即決購入（Buy Now）
**説明**: 即決価格が設定されている場合、ファンがオークションを待たずに即座に購入できる

**受け入れ条件**:
- [ ] 即決価格が設定されているオークションでのみ表示される
- [ ] ログイン済みユーザーのみ利用できる
- [ ] カード登録済みユーザーのみ利用できる
- [ ] 確認ダイアログが表示される
- [ ] 即決購入実行時に与信確保が成功する
- [ ] 即決購入成功時にオークションが即座に終了する
- [ ] purchased_slotsレコードが作成される
- [ ] 他の入札者の与信が解放される

**関連ファイル**:
- 実装: `src/pages/TalkDetail.tsx` (handleBuyNow関数)
- API: `POST /api/buy-now`
- バックエンド: `backend/src/routes/buyNow.ts`
- 技術仕様: [/docs/functional/functions/auction.md#3-即決購入](../functional/functions/auction.md)

---

### FR-004: リアルタイム更新
**説明**: オークション情報（最高入札額、残り時間等）がリアルタイムで更新される

**受け入れ条件**:
- [ ] 最高入札額が3秒ごとに更新される
- [ ] 自分が最高入札者の場合、緑色背景 + "You"バッジが表示される
- [ ] カウントダウンタイマーが1秒ごとに更新される
- [ ] オークション終了時にポーリングが停止する
- [ ] オークション終了検知後、適切な終了画面が表示される

**関連ファイル**:
- 実装: `src/pages/TalkDetail.tsx` (useEffect - ポーリング)
- コンポーネント: `src/components/CountdownTimer.tsx`
- 技術仕様: [/docs/functional/functions/auction.md#4-リアルタイム更新](../functional/functions/auction.md)

---

### FR-005: オークション終了処理
**説明**: オークション終了時刻到達時に自動的にオークションが終了し、落札者が決定される

**受け入れ条件**:
- [ ] end_time到達時に自動的にステータスが'ended'に更新される
- [ ] 最高入札者がcurrent_winner_idに保存される
- [ ] purchased_slotsレコードが作成される（決済は保留状態）
- [ ] 落札できなかった入札者の与信が解放される
- [ ] Edge Function（end-auction）が正常に実行される

**関連ファイル**:
- 実装: `supabase/functions/end-auction/index.ts`
- バックエンド: `backend/src/server.ts` (POST /api/auctions/finalize-ended)
- 技術仕様: [/docs/functional/functions/auction.md#5-オークション終了処理](../functional/functions/auction.md)

---

### FR-006: オークション終了後の画面表示
**説明**: オークション終了後、ユーザーの状態（落札者/入札者/閲覧者）に応じた適切な画面を表示

**受け入れ条件**:
- [ ] 落札者には「おめでとうございます」メッセージとTalk予定確認ボタンが表示される
- [ ] 入札者（非落札者）には「残念」メッセージと他の枠へのリンクが表示される
- [ ] 非入札者には「オークション終了」メッセージが表示される
- [ ] 各状態に応じた適切なアクションボタンが表示される

**関連ファイル**:
- 実装: `src/pages/TalkDetail.tsx` (オークション終了後の画面)
- 技術仕様: [/docs/functional/functions/auction.md#6-オークション終了後の画面表示](../functional/functions/auction.md)

---

### FR-007: 入札履歴表示
**説明**: オークションの入札履歴を閲覧できる

**受け入れ条件**:
- [ ] 入札時刻順（新しい順）で表示される
- [ ] 入札額が表示される
- [ ] 入札者名が表示される（匿名化も検討）
- [ ] 自分の入札がハイライト表示される

**関連ファイル**:
- 実装: `src/pages/BidHistory.tsx`

## 非機能要件

### パフォーマンス
- **NFR-001**: オークション情報の更新は3秒以内に反映される
- **NFR-002**: 入札処理は2秒以内に完了する
- **NFR-003**: 100件以上の同時入札でもシステムが安定動作する

### セキュリティ
- **NFR-004**: 入札額の検証はサーバーサイドで行われる
- **NFR-005**: ユーザー認証状態がすべての入札処理で検証される
- **NFR-006**: Stripe Payment Intentを使用した安全な決済処理
- **NFR-007**: 与信確保と決済確定が分離されている

### ユーザビリティ
- **NFR-008**: 入札ボタンは明確で押しやすい（タップ領域十分）
- **NFR-009**: エラーメッセージは具体的でわかりやすい
- **NFR-010**: カウントダウンタイマーは視認性が高い

### 信頼性
- **NFR-011**: オークション終了処理が失敗した場合、リトライが実行される
- **NFR-012**: 決済失敗時は自動的にロールバックされる

## ビジネスルール

### BR-001: 価格設定
- 最低入札価格: 100円以上
- 最小入札単位: 100円（変更可能）
- 即決価格: 開始価格より高く設定

### BR-002: オークション期間
- オークション終了時刻: Talk開始時刻の1時間前に自動設定
- 最低オークション期間: 1時間（推奨）

### BR-003: 入札制限
- 未ログインユーザーは入札不可
- カード未登録ユーザーは入札不可
- 自分が最高入札者の場合も再入札可能（上乗せ）

### BR-004: 決済タイミング
- 入札時: 与信確保のみ（Authorization）
- Talk完了後: 決済確定（Capture）
- Talk不成立: 与信解放（Cancel）

## 関連する他の要件

- [BR-002: Talk機能](./BR-002-talk.md) - オークション落札後のTalk実施
- [BR-003: 決済機能](./BR-003-payment.md) - 与信確保と決済確定
- [BR-004: 認証機能](./BR-004-authentication.md) - ユーザー認証とカード登録

## 変更履歴

| 日付 | 変更内容 | 理由 |
|------|----------|------|
| 2025-12-10 | 初回作成 | 業務要件ドキュメントの整備 |

## 備考

### 将来実装予定
- 自動入札機能（最高入札額+αで自動入札）
- 入札通知（他ユーザーが入札した際のプッシュ通知）
- オークション延長（終了間際の入札で自動延長）
- 入札履歴のエクスポート（CSV出力）

### 既知の制約
- 与信確保（Authorization）は最大7日間のみ有効（Stripe制限）
- リアルタイム更新はポーリング方式（WebSocketは未実装）
