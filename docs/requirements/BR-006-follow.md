# BR-006: フォロー機能

## 概要

ファンがお気に入りのインフルエンサーをフォローし、フォロー中のインフルエンサーのTalk枠を優先的に表示する機能。ファンとインフルエンサーの継続的な関係構築を支援します。

**ビジネス価値**:
- ファンは好きなインフルエンサーの新規Talk枠を見逃さない
- インフルエンサーはファンとの関係を深め、リピーターを増やせる
- プラットフォームはユーザーエンゲージメントを向上できる

## ユーザーストーリー

### US-001: インフルエンサーをフォロー（ファン視点）
```
As a ファン,
I want to 気に入ったインフルエンサーをフォローする,
So that そのインフルエンサーの新規Talk枠を優先的に表示できる
```

### US-002: フォロー解除（ファン視点）
```
As a ファン,
I want to フォロー中のインフルエンサーをアンフォローする,
So that 興味がなくなったインフルエンサーの情報を減らせる
```

### US-003: フォロー中のTalk枠を優先表示（ファン視点）
```
As a ファン,
I want to Topページでフォロー中のインフルエンサーのTalk枠を優先的に見る,
So that 見逃さずに入札できる
```

### US-004: フォロワー数確認（インフルエンサー視点）
```
As a インフルエンサー,
I want to 自分のフォロワー数を確認する,
So that 人気度を把握できる
```

### US-005: フォロー一覧確認（ファン視点）
```
As a ファン,
I want to フォロー中のインフルエンサー一覧を確認する,
So that フォロー状況を管理できる
```

## 機能要件

### FR-001: フォローボタン表示
**説明**: インフルエンサーページにフォローボタンを表示

**受け入れ条件**:
- [ ] インフルエンサーページ (`/i/{influencer_id}`) にフォローボタンが表示される
- [ ] フォロー前はピンク色「フォローする」ボタンが表示される
- [ ] フォロー中はグレー色「フォロー中」ボタンが表示される
- [ ] ログイン済みユーザーのみボタンが表示される
- [ ] 未ログインユーザーにはログインを促すメッセージが表示される
- [ ] 自分自身のページではフォローボタンは表示されない

**関連ファイル**:
- 実装: `src/pages/InfluencerPage.tsx`
- 技術仕様: [/docs/functional/functions/follow.md#フォローボタン](../functional/functions/follow.md)

---

### FR-002: フォロー実行
**説明**: ファンがインフルエンサーをフォローできる

**受け入れ条件**:
- [ ] 「フォローする」ボタンクリックでフォロー処理が実行される
- [ ] `follows` テーブルにレコードが作成される
- [ ] `follower_id` にファンのIDが設定される
- [ ] `followed_id` にインフルエンサーのIDが設定される
- [ ] フォロー成功時にボタンが「フォロー中」に変わる
- [ ] フォロー成功時にフォロワー数が+1される
- [ ] フォロー失敗時にエラーメッセージが表示される
- [ ] 既にフォロー中の場合はエラーメッセージが表示される

**関連ファイル**:
- 実装: `src/api/follows.ts` (followUser関数)
- データベース: `follows` テーブル
- 技術仕様: [/docs/functional/functions/follow.md#1-フォロー--アンフォロー](../functional/functions/follow.md)

---

### FR-003: アンフォロー実行
**説明**: ファンがフォロー中のインフルエンサーをアンフォローできる

**受け入れ条件**:
- [ ] 「フォロー中」ボタンクリックでアンフォロー処理が実行される
- [ ] `follows` テーブルからレコードが削除される
- [ ] アンフォロー成功時にボタンが「フォローする」に変わる
- [ ] アンフォロー成功時にフォロワー数が-1される
- [ ] アンフォロー失敗時にエラーメッセージが表示される
- [ ] 既にアンフォロー済みの場合はエラーメッセージが表示される

**関連ファイル**:
- 実装: `src/api/follows.ts` (unfollowUser関数)
- データベース: `follows` テーブル
- 技術仕様: [/docs/functional/functions/follow.md#1-フォロー--アンフォロー](../functional/functions/follow.md)

---

### FR-004: フォロー状態の確認
**説明**: ファンが特定のインフルエンサーをフォロー中かどうかを確認できる

**受け入れ条件**:
- [ ] インフルエンサーページ読み込み時にフォロー状態を確認する
- [ ] フォロー中の場合、`isFollowing: true` を返す
- [ ] 未フォローの場合、`isFollowing: false` を返す
- [ ] フォロー状態に基づいてボタン表示を切り替える
- [ ] 未ログインユーザーの場合は常に `false` を返す

**関連ファイル**:
- 実装: `src/api/follows.ts` (checkIsFollowing関数)
- 技術仕様: [/docs/functional/functions/follow.md#2-フォロー状態の確認](../functional/functions/follow.md)

---

### FR-005: フォロー中のインフルエンサー一覧取得
**説明**: ファンがフォロー中のインフルエンサーIDリストを取得できる

**受け入れ条件**:
- [ ] ログインユーザーのフォロー中インフルエンサーIDを取得できる
- [ ] IDの配列（string[]）が返される
- [ ] Topページのソート処理で使用される
- [ ] 未ログインユーザーの場合は空配列を返す
- [ ] エラー時は空配列を返す

**関連ファイル**:
- 実装: `src/api/follows.ts` (getFollowingInfluencerIds関数)
- 使用箇所: `src/pages/Home.tsx`
- 技術仕様: [/docs/functional/functions/follow.md#3-フォロー中のインフルエンサー一覧取得](../functional/functions/follow.md)

---

### FR-006: フォロワー数表示
**説明**: インフルエンサーページでフォロワー数を表示

**受け入れ条件**:
- [ ] インフルエンサーページにフォロワー数が表示される
- [ ] 「○○人がフォロー中」の形式で表示される
- [ ] アイコン（Users）とともに表示される
- [ ] フォロワー数がリアルタイムで更新される
- [ ] フォロワーが0人の場合も「0人がフォロー中」と表示される

**関連ファイル**:
- 実装: `src/pages/InfluencerPage.tsx`
- 技術仕様: [/docs/functional/functions/follow.md#4-フォロワー数表示](../functional/functions/follow.md)

---

### FR-007: フォロー中のTalk枠優先表示
**説明**: Topページでフォロー中のインフルエンサーのTalk枠を優先的に表示

**受け入れ条件**:
- [ ] オークション開催中（active）の枠が最優先表示される
- [ ] フォロー中のインフルエンサーの枠が優先表示される
- [ ] オークション終了時刻が近い順にソートされる
- [ ] フォロー中のTalk枠数が表示される（例: 「フォロー中: 3件」）
- [ ] 未ログインユーザーの場合は通常のソート順で表示される

**ソート優先順位**:
1. オークション開催中（active） > 終了済み（ended）
2. フォロー中のインフルエンサー > 未フォロー
3. オークション終了時刻が近い順

**関連ファイル**:
- 実装: `src/pages/Home.tsx`
- 技術仕様: [/docs/functional/functions/follow.md#5-フォロー中のtalk枠優先表示](../functional/functions/follow.md)

---

### FR-008: フォロー一覧ページ（将来実装）
**説明**: ファンがフォロー中のインフルエンサー一覧を閲覧できる

**受け入れ条件**:
- [ ] `/mypage?tab=following` でアクセスできる
- [ ] フォロー中のインフルエンサー一覧が表示される
- [ ] 各インフルエンサーの最新Talk枠が表示される
- [ ] アンフォローボタンが表示される
- [ ] フォロー日時が表示される
- [ ] インフルエンサー名クリックでインフルエンサーページに遷移する

**関連ファイル**:
- 実装: 将来実装予定
- 技術仕様: [/docs/functional/functions/follow.md#6-フォロー一覧ページ](../functional/functions/follow.md)

## 非機能要件

### パフォーマンス
- **NFR-001**: フォロー/アンフォロー処理は1秒以内に完了する
- **NFR-002**: フォロー状態確認は0.5秒以内に完了する
- **NFR-003**: フォロー中インフルエンサー一覧取得は1秒以内に完了する
- **NFR-004**: フォロワー数取得は0.5秒以内に完了する

### セキュリティ
- **NFR-005**: ユーザーは自分のフォローのみ作成・削除できる（RLS制御）
- **NFR-006**: フォロー情報は全員が閲覧可能（プライバシー設定は将来実装）
- **NFR-007**: 自分自身をフォローできない（CHECK制約）
- **NFR-008**: 同一ユーザーを重複フォローできない（UNIQUE制約）

### ユーザビリティ
- **NFR-009**: フォローボタンは目立つ位置に配置される
- **NFR-010**: フォロー/フォロー中のボタンデザインは明確に区別される
- **NFR-011**: フォロー中のTalk枠は視覚的に優先されていることがわかる
- **NFR-012**: フォロワー数は読みやすく表示される

### 信頼性
- **NFR-013**: フォロー失敗時はロールバックされる
- **NFR-014**: アンフォロー失敗時はエラーログが記録される
- **NFR-015**: フォロー状態の確認エラー時は未フォロー扱いとする

## ビジネスルール

### BR-001: フォロー制限
- 自分自身をフォローできない
- 同一インフルエンサーを重複フォローできない
- ログイン済みユーザーのみフォロー可能

### BR-002: フォロー・アンフォロー権限
- フォロー作成: 自分のフォローのみ作成可能
- フォロー削除: 自分のフォローのみ削除可能
- フォロー閲覧: 全員が閲覧可能

### BR-003: フォロワー数集計
- フォロー/アンフォロー時にリアルタイム更新
- または定期バッチ処理で集計（将来実装）
- `users.follower_count` に保存（将来実装）

### BR-004: 優先表示ルール
- フォロー中のTalk枠は、同じステータス（active/ended）内で優先表示
- オークション開催中が最優先（フォロー状態より上位）

## 関連する他の要件

- [BR-005: インフルエンサー管理](./BR-005-influencer.md) - インフルエンサーページの表示
- [BR-002: Talk機能](./BR-002-talk.md) - Talk枠一覧の優先表示

## 変更履歴

| 日付 | 変更内容 | 理由 |
|------|----------|------|
| 2025-12-10 | 初回作成 | 業務要件ドキュメントの整備 |

## 備考

### 将来実装予定
- フォロー一覧ページ（マイページタブ）
- 新規フォロワー通知（メール・プッシュ通知）
- フォロー中のインフルエンサーが新規Talk枠作成時の通知
- フォロー数・フォロワー数の統計情報更新（トリガーまたはバッチ）
- フォロー非公開設定（プライバシー）
- ブロック機能（特定ユーザーをブロック）
- フォロワー分析（新規フォロワー獲得数の推移グラフ）

### 既知の制約
- フォロー一覧ページは未実装
- フォロー通知は未実装
- フォロワー数の自動更新は未実装（手動カウント）
- プライバシー設定は未実装（全員が閲覧可能）

### データベース設計
```sql
CREATE TABLE follows (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  follower_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  followed_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(follower_id, followed_id),
  CHECK (follower_id != followed_id)
);

-- インデックス
CREATE INDEX idx_follows_follower_id ON follows(follower_id);
CREATE INDEX idx_follows_followed_id ON follows(followed_id);
CREATE INDEX idx_follows_follower_followed ON follows(follower_id, followed_id);
```

### セキュリティ対策
- RLS (Row Level Security) ポリシー:
  ```sql
  CREATE POLICY "Users can create own follows"
  ON follows FOR INSERT
  WITH CHECK (auth.uid() = follower_id);

  CREATE POLICY "Users can delete own follows"
  ON follows FOR DELETE
  USING (auth.uid() = follower_id);

  CREATE POLICY "Anyone can view follows"
  ON follows FOR SELECT
  USING (true);
  ```
