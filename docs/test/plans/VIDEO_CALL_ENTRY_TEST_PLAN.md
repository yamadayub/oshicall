# Video Call Entry テスト計画書

## 概要

ビデオ通話の入室状態表示と入室タイミングに関する機能を検証するためのテスト計画書です。

**対象業務仕様**: [/docs/business/video-call.md](../../business/video-call.md)

**テスト対象機能**:
- BR-008: 待機室での入室状態表示ルール
- BR-009: インフルエンサーの入室タイミング
- BR-010: ファンの入室タイミング

## テスト方針

### テストレベル

1. **E2Eテスト**: 実際のユーザーシナリオに沿ったテスト
   - インフルエンサーとファンの両方の視点からテスト
   - 2つのブラウザコンテキストを使用して同時にシミュレート

### テスト環境

- **ローカル環境**: 開発環境でのテスト
- **ステージング環境**: 本番相当環境でのテスト

### テストデータ

- テスト用ユーザー（ファン、インフルエンサー）
- テスト用Talk枠
- テスト用オークション（落札済み）
- 通話開始時刻を現在時刻から適切な時間に設定

## テストケース一覧

### BR-008: 待機室での入室状態表示ルール

#### TC-008-001: インフルエンサーが先に入室した場合

**テストケース名**: インフルエンサーが先に入室すると、ファンは未入室と表示される

**前提条件**:
- オークションが落札済み（purchased_slotsが作成済み）
- 通話開始時刻の15分前以降
- インフルエンサーアカウントが存在し、ログイン可能
- ファンアカウントが存在し、ログイン可能

**テスト手順**:
1. インフルエンサーがCallPageにアクセス
2. インフルエンサーの画面で参加状況を確認
3. ファンの画面で参加状況を確認（別ブラウザコンテキスト）

**期待結果**:
- インフルエンサーの画面: 自分が「待機中」、ファンが「未入室」と表示される
- ファンの画面: まだCallPageにアクセスしていないため、参加状況は表示されない

**テスト種別**: E2Eテスト

**優先度**: 高

---

#### TC-008-002: ファンが先に入室した場合

**テストケース名**: ファンが先に入室すると、インフルエンサーは未入室と表示される

**前提条件**:
- オークションが落札済み（purchased_slotsが作成済み）
- 通話開始時刻以降
- インフルエンサーアカウントが存在し、ログイン可能
- ファンアカウントが存在し、ログイン可能

**テスト手順**:
1. ファンがCallPageにアクセス
2. ファンの画面で参加状況を確認
3. インフルエンサーの画面で参加状況を確認（別ブラウザコンテキスト）

**期待結果**:
- ファンの画面: 自分が「待機中」、インフルエンサーが「未入室」と表示される
- インフルエンサーの画面: まだCallPageにアクセスしていないため、参加状況は表示されない

**テスト種別**: E2Eテスト

**優先度**: 高

---

#### TC-008-003: 両者がCallPageに入室した場合

**テストケース名**: 両者がCallPageに入室すると、両者とも待機中と表示される

**前提条件**:
- オークションが落札済み（purchased_slotsが作成済み）
- インフルエンサーが15分前からCallPageに入室済み
- ファンが開始時刻からCallPageに入室済み

**テスト手順**:
1. インフルエンサーがCallPageにアクセス
2. ファンがCallPageにアクセス（別ブラウザコンテキスト）
3. 両者の画面で参加状況を確認

**期待結果**:
- インフルエンサーの画面: 自分が「待機中」、ファンが「待機中」と表示される
- ファンの画面: 自分が「待機中」、インフルエンサーが「待機中」と表示される

**テスト種別**: E2Eテスト

**優先度**: 高

---

#### TC-008-004: 両者がDaily.co接続中の場合

**テストケース名**: 両者がDaily.coに接続すると、両者とも通話中と表示される

**前提条件**:
- 両者がCallPageに入室済み
- 通話開始時刻になっている（または15分前以降でインフルエンサーが接続可能）
- 両者がDaily.coセッションに接続済み

**テスト手順**:
1. インフルエンサーが「通話を開始する」ボタンをクリック
2. ファンが「通話を開始する」ボタンをクリック（または自動接続）
3. 両者の画面で参加状況を確認

**期待結果**:
- インフルエンサーの画面: 自分が「通話中」、ファンが「通話中」と表示される
- ファンの画面: 自分が「通話中」、インフルエンサーが「通話中」と表示される

**テスト種別**: E2Eテスト

**優先度**: 高

---

#### TC-008-005: 片方がDaily.co接続、もう片方が未接続の場合

**テストケース名**: 片方がDaily.coに接続し、もう片方が未接続の場合の表示

**前提条件**:
- 両者がCallPageに入室済み
- 通話開始時刻になっている（または15分前以降でインフルエンサーが接続可能）
- インフルエンサーのみDaily.coセッションに接続済み

**テスト手順**:
1. インフルエンサーが「通話を開始する」ボタンをクリック
2. ファンは接続しない
3. 両者の画面で参加状況を確認

**期待結果**:
- インフルエンサーの画面: 自分が「通話中」、ファンが「待機中」と表示される
- ファンの画面: 自分が「待機中」、インフルエンサーが「通話中」と表示される

**テスト種別**: E2Eテスト

**優先度**: 中

---

### BR-009: インフルエンサーの入室タイミング

#### TC-009-001: 15分前にCallPage入室可能

**テストケース名**: インフルエンサーは15分前からCallPageに入室できる

**前提条件**:
- オークションが落札済み（purchased_slotsが作成済み）
- 通話開始時刻の15分前
- インフルエンサーアカウントが存在し、ログイン可能

**テスト手順**:
1. インフルエンサーがCallPageにアクセス
2. 画面の表示を確認

**期待結果**:
- CallPageが表示される
- 待機画面が表示される
- カウントダウンタイマーが表示される

**テスト種別**: E2Eテスト

**優先度**: 高

---

#### TC-009-002: 15分前にDaily.co接続可能

**テストケース名**: インフルエンサーは15分前からDaily.coに接続できる

**前提条件**:
- オークションが落札済み（purchased_slotsが作成済み）
- 通話開始時刻の15分前
- インフルエンサーがCallPageに入室済み

**テスト手順**:
1. インフルエンサーが「通話を開始する」ボタンをクリック
2. Daily.coセッションへの接続を試みる
3. 接続状態を確認

**期待結果**:
- Daily.coセッションに接続できる
- ビデオ通話画面が表示される
- エラーが発生しない

**テスト種別**: E2Eテスト

**優先度**: 高

---

#### TC-009-003: 16分前はDaily.co接続不可

**テストケース名**: インフルエンサーは16分前はDaily.coに接続できない

**前提条件**:
- オークションが落札済み（purchased_slotsが作成済み）
- 通話開始時刻の16分前
- インフルエンサーがCallPageに入室済み

**テスト手順**:
1. インフルエンサーが「通話を開始する」ボタンの状態を確認
2. ボタンがクリック可能な場合、クリックして接続を試みる

**期待結果**:
- Daily.coセッションに接続できない
- エラーメッセージが表示される（またはボタンが無効化されている）
- 適切なエラーハンドリングが行われる

**テスト種別**: E2Eテスト

**優先度**: 中

---

#### TC-009-004: ちょうど15分前（エッジケース）

**テストケース名**: インフルエンサーはちょうど15分前からDaily.coに接続できる

**前提条件**:
- オークションが落札済み（purchased_slotsが作成済み）
- 通話開始時刻のちょうど15分前（秒単位で一致）
- インフルエンサーがCallPageに入室済み

**テスト手順**:
1. インフルエンサーが「通話を開始する」ボタンをクリック
2. Daily.coセッションへの接続を試みる

**期待結果**:
- Daily.coセッションに接続できる
- エラーが発生しない

**テスト種別**: E2Eテスト

**優先度**: 中

---

#### TC-009-005: 開始時刻の30分後まで入室可能

**テストケース名**: インフルエンサーは開始時刻の30分後までCallPageに入室できる

**前提条件**:
- オークションが落札済み（purchased_slotsが作成済み）
- 通話開始時刻の30分後
- インフルエンサーアカウントが存在し、ログイン可能

**テスト手順**:
1. インフルエンサーがCallPageにアクセス
2. 画面の表示を確認

**期待結果**:
- CallPageが表示される
- エラーが発生しない

**テスト種別**: E2Eテスト

**優先度**: 低

---

### BR-010: ファンの入室タイミング

#### TC-010-001: 開始前にCallPage入室可能（待機画面表示）

**テストケース名**: ファンは開始前にCallPageに入室できる（待機画面表示）

**前提条件**:
- オークションが落札済み（purchased_slotsが作成済み）
- 通話開始時刻の前（例: 1時間前）
- ファンアカウントが存在し、ログイン可能

**テスト手順**:
1. ファンがCallPageにアクセス
2. 画面の表示を確認

**期待結果**:
- CallPageが表示される
- 待機画面が表示される
- カウントダウンタイマーが表示される
- 「通話を開始する」ボタンが無効化されている（または表示されていない）

**テスト種別**: E2Eテスト

**優先度**: 高

---

#### TC-010-002: 開始時刻に自動でDaily.co接続

**テストケース名**: ファンは開始時刻に自動でDaily.coに接続される

**前提条件**:
- オークションが落札済み（purchased_slotsが作成済み）
- ファンがCallPageに入室済み
- 通話開始時刻になった

**テスト手順**:
1. ファンがCallPageに入室
2. 通話開始時刻を待つ
3. 自動接続の動作を確認

**期待結果**:
- 通話開始時刻になると自動的にDaily.coセッションに接続される
- ビデオ通話画面が表示される
- エラーが発生しない

**テスト種別**: E2Eテスト

**優先度**: 高

---

#### TC-010-003: 開始後はDaily.co接続済み

**テストケース名**: ファンは開始後はDaily.co接続済み状態になる

**前提条件**:
- オークションが落札済み（purchased_slotsが作成済み）
- 通話開始時刻の後（例: 5分後）
- ファンがCallPageに入室済み

**テスト手順**:
1. ファンがCallPageにアクセス
2. 「通話を開始する」ボタンをクリック
3. 接続状態を確認

**期待結果**:
- Daily.coセッションに接続できる
- ビデオ通話画面が表示される
- エラーが発生しない

**テスト種別**: E2Eテスト

**優先度**: 高

---

#### TC-010-004: ちょうど開始時刻（エッジケース）

**テストケース名**: ファンはちょうど開始時刻に自動でDaily.coに接続される

**前提条件**:
- オークションが落札済み（purchased_slotsが作成済み）
- ファンがCallPageに入室済み
- 通話開始時刻のちょうど（秒単位で一致）

**テスト手順**:
1. ファンがCallPageに入室
2. 通話開始時刻を待つ
3. 自動接続の動作を確認

**期待結果**:
- 通話開始時刻になると自動的にDaily.coセッションに接続される
- エラーが発生しない

**テスト種別**: E2Eテスト

**優先度**: 中

---

#### TC-010-005: 開始時刻の30分後まで入室可能

**テストケース名**: ファンは開始時刻の30分後までCallPageに入室できる

**前提条件**:
- オークションが落札済み（purchased_slotsが作成済み）
- 通話開始時刻の30分後
- ファンアカウントが存在し、ログイン可能

**テスト手順**:
1. ファンがCallPageにアクセス
2. 画面の表示を確認

**期待結果**:
- CallPageが表示される
- エラーが発生しない

**テスト種別**: E2Eテスト

**優先度**: 低

---

## E2Eテストシナリオ

### E2E-001: 完全な入室フローテスト（インフルエンサー先入室）

**テストケース名**: インフルエンサーが15分前に入室し、ファンが開始時刻に入室する完全なフロー

**前提条件**:
- インフルエンサーアカウントが存在し、ログイン可能
- ファンアカウントが存在し、ログイン可能
- オークションが落札済み（purchased_slotsが作成済み）

**テスト手順**:
1. インフルエンサーが15分前にCallPageにアクセス
2. **検証**: インフルエンサーの画面で自分が「待機中」、ファンが「未入室」と表示される
3. インフルエンサーが「通話を開始する」ボタンをクリック
4. **検証**: Daily.coセッションに接続できる
5. ファンが開始時刻にCallPageにアクセス
6. **検証**: ファンの画面で自分が「待機中」、インフルエンサーが「通話中」と表示される
7. ファンが「通話を開始する」ボタンをクリック（または自動接続）
8. **検証**: 両者の画面で両者とも「通話中」と表示される

**期待結果**:
- 各段階で適切な状態が表示される
- 入室タイミングが正しく制御される

**テスト種別**: E2Eテスト

**優先度**: 高

---

### E2E-002: 完全な入室フローテスト（ファン先入室）

**テストケース名**: ファンが開始前に入室し、インフルエンサーが15分前に入室する完全なフロー

**前提条件**:
- インフルエンサーアカウントが存在し、ログイン可能
- ファンアカウントが存在し、ログイン可能
- オークションが落札済み（purchased_slotsが作成済み）

**テスト手順**:
1. ファンが開始前にCallPageにアクセス
2. **検証**: ファンの画面で自分が「待機中」、インフルエンサーが「未入室」と表示される
3. インフルエンサーが15分前にCallPageにアクセス
4. **検証**: 両者の画面で両者とも「待機中」と表示される
5. インフルエンサーが「通話を開始する」ボタンをクリック
6. **検証**: インフルエンサーがDaily.coセッションに接続できる
7. ファンが開始時刻に自動接続（または手動接続）
8. **検証**: 両者の画面で両者とも「通話中」と表示される

**期待結果**:
- 各段階で適切な状態が表示される
- 入室タイミングが正しく制御される

**テスト種別**: E2Eテスト

**優先度**: 高

---

## テスト実行チェックリスト

### 準備

- [ ] テスト環境がセットアップ済み
- [ ] テストデータが準備済み
- [ ] テスト用アカウントが作成済み
- [ ] データベースバックアップが取得済み

### BR-008テスト

- [ ] TC-008-001: インフルエンサーが先に入室した場合
- [ ] TC-008-002: ファンが先に入室した場合
- [ ] TC-008-003: 両者がCallPageに入室した場合
- [ ] TC-008-004: 両者がDaily.co接続中の場合
- [ ] TC-008-005: 片方がDaily.co接続、もう片方が未接続の場合

### BR-009テスト

- [ ] TC-009-001: 15分前にCallPage入室可能
- [ ] TC-009-002: 15分前にDaily.co接続可能
- [ ] TC-009-003: 16分前はDaily.co接続不可
- [ ] TC-009-004: ちょうど15分前（エッジケース）
- [ ] TC-009-005: 開始時刻の30分後まで入室可能

### BR-010テスト

- [ ] TC-010-001: 開始前にCallPage入室可能（待機画面表示）
- [ ] TC-010-002: 開始時刻に自動でDaily.co接続
- [ ] TC-010-003: 開始後はDaily.co接続済み
- [ ] TC-010-004: ちょうど開始時刻（エッジケース）
- [ ] TC-010-005: 開始時刻の30分後まで入室可能

### E2Eテスト

- [ ] E2E-001: 完全な入室フローテスト（インフルエンサー先入室）
- [ ] E2E-002: 完全な入室フローテスト（ファン先入室）

## テスト結果記録

### テスト実行日時
- 実行日: YYYY-MM-DD
- 実行者: [名前]
- 環境: [ローカル/ステージング]

### テスト結果サマリー

| テストケースID | テストケース名 | 結果 | 備考 |
|---------------|--------------|------|------|
| TC-008-001 | インフルエンサーが先に入室した場合 | ✅/❌ | |
| TC-008-002 | ファンが先に入室した場合 | ✅/❌ | |
| TC-008-003 | 両者がCallPageに入室した場合 | ✅/❌ | |
| TC-008-004 | 両者がDaily.co接続中の場合 | ✅/❌ | |
| TC-008-005 | 片方がDaily.co接続、もう片方が未接続の場合 | ✅/❌ | |
| TC-009-001 | 15分前にCallPage入室可能 | ✅/❌ | |
| TC-009-002 | 15分前にDaily.co接続可能 | ✅/❌ | |
| TC-009-003 | 16分前はDaily.co接続不可 | ✅/❌ | |
| TC-009-004 | ちょうど15分前（エッジケース） | ✅/❌ | |
| TC-009-005 | 開始時刻の30分後まで入室可能 | ✅/❌ | |
| TC-010-001 | 開始前にCallPage入室可能（待機画面表示） | ✅/❌ | |
| TC-010-002 | 開始時刻に自動でDaily.co接続 | ✅/❌ | |
| TC-010-003 | 開始後はDaily.co接続済み | ✅/❌ | |
| TC-010-004 | ちょうど開始時刻（エッジケース） | ✅/❌ | |
| TC-010-005 | 開始時刻の30分後まで入室可能 | ✅/❌ | |
| E2E-001 | 完全な入室フローテスト（インフルエンサー先入室） | ✅/❌ | |
| E2E-002 | 完全な入室フローテスト（ファン先入室） | ✅/❌ | |

### 発見された問題

#### 問題1: [タイトル]
- **発生条件**: 
- **再現手順**: 
- **期待結果**: 
- **実際の結果**: 
- **優先度**: 高/中/低
- **ステータス**: 新規/修正中/修正済み

## 関連ドキュメント

- [業務仕様ドキュメント](../../business/video-call.md)
- [E2Eテストガイド](../E2E_TEST_GUIDE.md)
- [ステージング環境テストガイド](../STAGING_E2E_TEST_GUIDE.md)

## 変更履歴

| 日付 | 変更内容 | 理由 |
|------|----------|------|
| 2025-01-XX | 初回作成 | ビデオ通話入室機能のテスト計画作成 |

