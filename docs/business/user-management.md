# ユーザー管理業務

## 概要

ユーザーの認証、プロフィール管理、インフルエンサー管理、フォロー、ランキングなどのユーザー関連業務を統合的に管理する業務。ユーザーが安全かつ快適にサービスを利用できる基盤を提供します。

**ビジネス価値**:
- ユーザーは簡単にアカウントを作成し、サービスを利用開始できる
- セキュアな認証により、ユーザーデータを保護できる
- インフルエンサーは効率的に活動を管理し、収益化できる
- ファンはお気に入りのインフルエンサーをフォローし、見逃さない

## ユーザーストーリー

### 認証関連

#### US-001: Google OAuthログイン（ファン/インフルエンサー共通）
```
As a ユーザー,
I want to Googleアカウントでログインする,
So that パスワードを覚えなくても簡単にログインできる
```

#### US-002: プロフィール管理（ファン/インフルエンサー共通）
```
As a ユーザー,
I want to プロフィール情報（名前、自己紹介、画像）を編集する,
So that 自分を他のユーザーに適切にアピールできる
```

### インフルエンサー管理関連

#### US-003: Talk枠作成（インフルエンサー視点）
```
As a インフルエンサー,
I want to Talk枠を簡単に作成する,
So that ファンに通話機会を提供し、収益を得られる
```

#### US-004: ダッシュボード閲覧（インフルエンサー視点）
```
As a インフルエンサー,
I want to 自分のTalk枠一覧と売上を一画面で確認する,
So that 活動状況を把握できる
```

#### US-005: インフルエンサーページ閲覧（ファン視点）
```
As a ファン,
I want to 特定のインフルエンサーのページを閲覧する,
So that そのインフルエンサーの情報やTalk枠を確認できる
```

### フォロー関連

#### US-006: インフルエンサーをフォロー（ファン視点）
```
As a ファン,
I want to 気に入ったインフルエンサーをフォローする,
So that そのインフルエンサーの新規Talk枠を優先的に表示できる
```

#### US-007: フォロー中のTalk枠を優先表示（ファン視点）
```
As a ファン,
I want to Topページでフォロー中のインフルエンサーのTalk枠を優先的に見る,
So that 見逃さずに入札できる
```

### ランキング関連

#### US-008: インフルエンサーランキング閲覧（ファン視点）
```
As a ファン,
I want to 人気のインフルエンサーをランキング形式で見る,
So that 注目のインフルエンサーを発見できる
```

## ビジネスルール

### 認証関連

#### BR-001: 認証方式
- **説明**: ユーザー認証の方式に関するルール
- **条件**:
  - 現在: Google OAuthのみサポート
  - 将来: メール/パスワード認証も検討
- **結果**: ユーザーが簡単にログインできる

#### BR-002: ユーザー情報
- **説明**: ユーザー情報の作成と管理に関するルール
- **条件**:
  - 初回ログイン時に自動的に`users`テーブルにレコードを作成
  - `auth.users.id`と`public.users.id`は同一
  - メールアドレスはGoogleから取得
- **結果**: ユーザー情報が適切に管理される

#### BR-003: プロフィール画像
- **説明**: プロフィール画像のアップロードに関するルール
- **条件**:
  - 最大サイズ: 1MB
  - 対応形式: JPEG, PNG, WebP
  - ストレージ: Supabase Storage（`avatars`バケット）
- **結果**: 適切なサイズ・形式の画像のみがアップロードされる

#### BR-004: セッション
- **説明**: ログインセッションの管理に関するルール
- **条件**:
  - 有効期限: 1時間（自動更新）
  - 更新タイミング: ページ遷移時
  - 切れた場合: 自動ログアウト
- **結果**: セキュアなセッション管理が実現される

#### BR-005: アクセス制御
- **説明**: 未ログインユーザーのアクセス制限に関するルール
- **条件**:
  - 未ログインユーザーは入札不可
  - 未ログインユーザーはマイページアクセス不可
  - 未ログインユーザーはインフルエンサーダッシュボードアクセス不可
- **結果**: 適切な権限管理が実現される

### インフルエンサー管理関連

#### BR-006: インフルエンサー判定
- **説明**: インフルエンサーとして識別される条件に関するルール
- **条件**:
  - `users.is_influencer`が`true`のユーザーのみインフルエンサー機能にアクセス可能
  - 将来: インフルエンサー申請・承認フローの実装
- **結果**: 適切なユーザーのみがインフルエンサー機能を利用できる

#### BR-007: Talk枠作成制限
- **説明**: Talk枠作成に関する制限ルール
- **条件**:
  - 通話開始予定時刻は未来の日時のみ
  - 通話時間は最低5分以上
  - 開始価格は100円以上
  - 即決価格は開始価格より高く設定
- **結果**: 適正なTalk枠のみが作成される

#### BR-008: 売上計算
- **説明**: インフルエンサーの売上計算に関するルール
- **条件**:
  - 総売上額 = 完了したTalkの落札額の合計
  - プラットフォーム手数料控除後の金額（将来実装）
  - リアルタイム更新または定期バッチ集計
- **結果**: 正確な売上情報が提供される

### フォロー関連

#### BR-009: フォロー制限
- **説明**: フォロー機能の制限に関するルール
- **条件**:
  - 自分自身をフォローできない
  - 同一インフルエンサーを重複フォローできない
  - ログイン済みユーザーのみフォロー可能
- **結果**: 適切なフォロー関係が構築される

#### BR-010: 優先表示ルール
- **説明**: フォロー中のTalk枠の優先表示に関するルール
- **条件**:
  - フォロー中のTalk枠は、同じステータス（active/ended）内で優先表示
  - オークション開催中が最優先（フォロー状態より上位）
- **結果**: ファンが見逃しにくくなる

### ランキング関連

#### BR-011: ランキング基準
- **説明**: ランキングの集計基準に関するルール
- **条件**:
  - 総売上ランキング: `users.total_earned`の降順
  - 完了Talk数ランキング: `users.total_calls_completed`の降順
  - 平均評価ランキング: `users.average_rating`の降順（最低レビュー数5件以上）
  - フォロワー数ランキング: `users.follower_count`の降順
- **結果**: 公平なランキングが表示される

#### BR-012: ランキング表示件数
- **説明**: ランキングの表示件数に関するルール
- **条件**:
  - デフォルト: 上位10名/件
  - 将来: ページネーションで20件、50件表示も検討
- **結果**: 適切な情報量が提供される

#### BR-013: ランキング順位同率の場合
- **説明**: 同率順位の扱いに関するルール
- **条件**:
  - 同率の場合は登録日時順（古い順）で並べる
- **結果**: 一意な順位が決定される

## 業務フロー

### ユーザー登録・ログインフロー
```
1. ユーザーが「Googleでログイン」ボタンをクリック
   ↓
2. Googleログイン画面に遷移
   ↓
3. Googleアカウント選択
   ↓
4. OshiTalkにリダイレクト
   ↓
5. 初回ログイン時: usersテーブルにレコード作成
   2回目以降: 既存ユーザー情報を取得
   ↓
6. ログイン完了
```

### インフルエンサー活動フロー
```
1. インフルエンサーがダッシュボードにアクセス
   ↓
2. Talk枠を作成
   ↓
3. オークションが開始
   ↓
4. 入札・落札
   ↓
5. Talk実施
   ↓
6. 売上が更新される
```

### フォローフロー
```
1. ファンがインフルエンサーページにアクセス
   ↓
2. 「フォローする」ボタンをクリック
   ↓
3. followsテーブルにレコード作成
   ↓
4. フォロワー数が+1
   ↓
5. Topページでフォロー中のTalk枠が優先表示される
```

## 制約事項

### ビジネス上の制約
- Google OAuthのみサポート（メール/パスワード未実装）
- プロフィール画像は1枚のみ（複数枚未対応）
- セッション有効期限は固定（1時間）
- ランキングはリアルタイム集計（キャッシュ未実装）
- 期間フィルターは未実装（全期間のみ）

### 技術的制約
- パスワードはSupabase Authでハッシュ化される
- JWTトークンは有効期限付きで発行される
- ユーザーは自分のデータのみ更新できる（RLS制御）
- フォロー情報は全員が閲覧可能（プライバシー設定は将来実装）

## 用語定義

| 用語 | 定義 |
|------|------|
| ファン | インフルエンサーのTalk枠を購入し、通話を楽しむユーザー |
| インフルエンサー | Talk枠を作成・販売し、ファンと通話を実施して収益を得るユーザー |
| フォロー | ファンがインフルエンサーをお気に入り登録する機能 |
| フォロワー | インフルエンサーをフォローしているファン |
| フォロワー数 | インフルエンサーをフォローしているファンの数 |
| 総売上ランキング | インフルエンサーの総売上額順のランキング |
| 完了Talk数ランキング | インフルエンサーの完了Talk数順のランキング |
| 平均評価ランキング | インフルエンサーの平均評価順のランキング |

## 変更履歴

| 日付 | 変更内容 | 理由 | 承認者 |
|------|----------|------|--------|
| 2025-12-10 | 初回作成（認証、インフルエンサー管理、フォロー、ランキングを個別に作成） | 業務要件ドキュメントの整備 | - |
| 2025-01-XX | ユーザー管理業務として統合 | ドキュメント体系の整理 | - |

## 関連する業務

- [オークション業務](./auction.md) - ログイン必須、入札機能
- [ビデオ通話業務](./video-call.md) - Talk枠作成とTalk実施
- [決済業務](./payment.md) - Stripe顧客作成時にユーザー情報を使用

