# 決済業務

## 概要

Stripe APIを使用した安全な決済処理システム。オークション入札時に与信確保（Authorization）を行い、Talk完了後に決済確定（Capture）する2段階決済により、ファンとインフルエンサーの両方にとって公平な決済を実現します。

**ビジネス価値**:
- ファンはTalk完了後のみ課金され、不公平な決済を回避できる
- インフルエンサーはサービス提供後に確実に収益を得られる
- プラットフォームはPCI DSS準拠の安全な決済システムを提供

## ユーザーストーリー

### US-001: カード情報登録（ファン視点）
```
As a ファン,
I want to カード情報を安全に登録する,
So that オークションに入札できる
```

### US-002: 入札時の与信確保（ファン視点）
```
As a ファン,
I want to 入札時点では課金されない,
So that 落札できなかった場合に無駄な決済が発生しない
```

### US-003: Talk完了後の決済確定（ファン視点）
```
As a ファン,
I want to Talkが正常完了した場合のみ課金される,
So that インフルエンサーが不在でも課金されることがない
```

### US-004: Talk不成立時の与信解放（ファン視点）
```
As a ファン,
I want to Talkが成立しなかった場合に与信が解放される,
So that カードの利用可能額が適切に戻る
```

### US-005: 売上確認（インフルエンサー視点）
```
As a インフルエンサー,
I want to 完了したTalkの売上を確認する,
So that 収益状況を把握できる
```

## ビジネスルール

### BR-001: 決済タイミング
- **説明**: 入札時とTalk完了時の決済処理に関するルール
- **条件**:
  - 入札時: 与信確保のみ（Authorization）
  - Talk完了後: 決済確定（Capture）
  - Talk不成立: 与信解放（Cancel）
- **結果**: ファンは正常完了時のみ課金され、不公平な決済を回避できる

### BR-002: 与信有効期限
- **説明**: 与信確保の有効期限に関するルール
- **条件**:
  - Stripe Payment Intentの与信は最大7日間有効
  - 7日以内にTalkを完了する必要がある
  - 7日経過後は自動的に与信が解放される
- **結果**: 適切な期間内にTalkが完了することを促進

### BR-003: プラットフォーム手数料
- **説明**: プラットフォームが徴収する手数料に関するルール
- **手数料率**:
  - デフォルト: 20%（0.2）
  - 初期インフルエンサー: 0%（0.0）に設定可能
  - インフルエンサーごとに手数料率を設定可能（0.0-1.0）
- **決済方式**:
  - **Destination Charges方式**: オンボーディング完了済みのインフルエンサーに対して適用
    - PaymentIntent作成時に`application_fee_amount`を指定
    - Capture実行時に自動的に分割入金（インフルエンサー: 総額 - 手数料、プラットフォーム: 手数料）
    - Transfer処理が不要
  - **Direct Charges方式**: オンボーディング未完了のインフルエンサーに対して適用（フォールバック）
    - 従来の方式（Capture実行後にTransfer処理）
- **結果**: プラットフォームの収益を確保し、インフルエンサーごとに柔軟な手数料設定が可能

### BR-004: カード登録制限
- **説明**: カード登録に関するルール
- **条件**:
  - 1ユーザーにつき1枚のカードのみ登録可能（現在）
  - カード登録なしでは入札不可
- **結果**: 確実に決済可能なユーザーのみが入札できる

### BR-005: テストカード
- **説明**: テスト環境でのカード使用に関するルール
- **条件**:
  - Staging環境ではStripeテストカードのみ使用可能
  - 成功カード: `4242 4242 4242 4242`
  - 失敗カード: `4000 0000 0000 0002`（カード拒否）
- **結果**: 安全にテストが実施できる

### BR-006: Talk完了判定による決済処理
- **説明**: Talk完了判定に基づく決済処理の分岐に関するルール
- **条件**:
  - 正常完了（インフルエンサー参加・時間経過・途中退出なし）: 決済確定
  - インフルエンサーno-show: 与信解放
  - インフルエンサー途中退出: 与信解放
  - 手動早期終了: 与信解放
- **結果**: 公平な決済判定が実現される

### BR-007: インフルエンサーへの送金タイミング
- **説明**: インフルエンサーへの送金処理に関するルール
- **送金タイミング**: 
  - Talk完了後、ファンからの決済確定（Capture）を実行
  - 決済確定（Capture）後、即座に送金（Transfer）を実行
  - **Destination Charges方式の場合**: Transfer処理は不要（Capture時に自動分割済み）
  - **Direct Charges方式の場合**: Capture実行後、即座にTransfer処理を実行
- **理由**: 
  - Capture実行時にプラットフォームアカウントへの入金が確定するため、即座にTransfer処理を実行可能
  - Webhookに依存しない同期処理により、確実な送金が実現される
  - エラー発生時も即座に検知でき、リトライ処理が容易
- **結果**: Capture実行と同時に送金処理が完了するため、インフルエンサーへの入金が迅速に行われる

### BR-008: インフルエンサーの売上表示
- **説明**: インフルエンサーのマイページでの売上表示に関するルール
- **表示項目**:
  - **総売上（受取額）**: Transfer済みの金額（`stripe_transfer_id`が設定されている`payment_transactions`の`influencer_payout`を集計）
  - **入金予定額**: Capture済みだがTransfer未実施の金額（`stripe_transfer_id`が`null`かつ`status='captured'`の`payment_transactions`の`influencer_payout`を集計）
  - **Stripe残高**: Stripe Connectアカウントの残高情報（参考情報として表示）
- **表示タイミング**:
  - Capture後、Transfer前でも入金予定額が即座に表示される
  - Transfer後、総売上（受取額）に反映される
- **結果**: インフルエンサーはTalk完了後、即座に入金予定額を確認できる

## 業務フロー

### 2段階決済フロー
```
1. 入札時: 与信確保（Authorization）
   - カードの有効性確認
   - 利用可能額の確認
   - 金額を一時的に「保留」
   ↓
2. オークション終了
   - 落札者: 与信を保持
   - 非落札者: 与信解放
   ↓
3. Talk実施
   ↓
4. Talk完了判定
   ↓
5. 正常完了の場合: 決済確定（Capture）
   不成立の場合: 与信解放（Cancel）
```

### エラーケース

#### ケース1: インフルエンサーno-show
- **イベント**: インフルエンサー不参加
- **判定結果**: `influencer_no_show`
- **処理**: 与信解放（Cancel）
- **ファンへの影響**: 課金なし

#### ケース2: インフルエンサー途中退出
- **イベント**: インフルエンサーが開始時刻から終了時刻までの間に退出
- **判定結果**: `influencer_left_during_talk`
- **処理**: 与信解放（Cancel）
- **ファンへの影響**: 課金なし
- **注意**: 開始時刻前に入室して待機することは可能。開始時刻から終了時刻まで連続参加が必要

#### ケース3: 手動早期終了
- **イベント**: 規定時間前に手動で終了ボタンを押す
- **判定結果**: `room_not_ended_by_duration`
- **処理**: 与信解放（Cancel）
- **ファンへの影響**: 課金なし

#### ケース4: 正常完了
- **イベント**: 規定時間まで通話実施
- **判定結果**: `completed_successfully`
- **処理**: 決済確定（Capture）
- **ファンへの影響**: 課金確定

## 制約事項

### ビジネス上の制約
- 与信確保は最大7日間のみ有効（Stripe制限）
- 決済通貨は日本円（JPY）のみ
- Stripeテストモードではリアルな決済は発生しない
- プラットフォーム手数料は現在未実装

### 技術的制約
- カード情報は自社サーバーに保存されない（PCI DSS準拠）
- Stripe Elementsを使用してカード情報を送信する
- Payment Intent IDのみをデータベースに保存する
- すべての決済関連通信はHTTPSで行われる

## 用語定義

| 用語 | 定義 |
|------|------|
| 与信確保（Authorization） | 入札時にカードの有効性を確認し、金額を一時的に「保留」する処理 |
| 決済確定（Capture） | Talk完了後に与信を確定し、実際に決済を実行する処理 |
| 与信解放（Cancel） | Talk不成立時またはオークション落札失敗時に与信を解放する処理 |
| Payment Intent | Stripeの決済オブジェクト。与信確保から決済確定までの一連の処理を管理 |
| Payment Method | Stripeに登録されたカード情報 |
| Stripe顧客 | Stripeで管理されるユーザーアカウント |
| プラットフォーム手数料 | 決済額の一定割合をプラットフォームが徴収する手数料 |
| インフルエンサー配分 | 決済額からプラットフォーム手数料を引いた、インフルエンサーへの支払額 |

## 変更履歴

| 日付 | 変更内容 | 理由 | 承認者 |
|------|----------|------|--------|
| 2025-12-10 | 初回作成 | 業務要件ドキュメントの整備 | - |
| 2025-01-XX | 業務仕様として再構成 | ドキュメント体系の整理 | - |
| 2026-01-03 | BR-007（送金タイミング）、BR-008（売上表示）を追加 | CaptureとTransferの分離、入金予定額の表示要件追加 | - |
| 2026-01-04 | BR-003を更新、Destination Charges方式を追加 | マーケットプレイス型決済への移行、インフルエンサーごとの手数料率設定 | - |
| 2026-01-04 | BR-007を更新 | Capture時にTransfer処理を実行する方式に変更（Webhook不要） | - |

## 関連する業務

- [オークション業務](./auction.md) - 入札時の与信確保
- [ビデオ通話業務](./video-call.md) - Talk完了後の決済確定
- [ユーザー管理業務](./user-management.md) - ユーザー認証とStripe顧客紐付け

