# オークション業務

## 概要

インフルエンサーが提供するTalk枠（通話枠）を、ファンがオークション形式で購入できる業務。リアルタイム入札と即決購入の2つの購入方式を提供し、公平かつスムーズな価格決定を実現します。

**ビジネス価値**:
- ファンは市場価格でTalk枠を購入できる
- インフルエンサーは需要に応じた適正価格で販売できる
- プラットフォームは競争的な価格設定により収益を最大化

## ユーザーストーリー

### US-001: リアルタイム入札（ファン視点）
```
As a ファン,
I want to 気に入ったTalk枠に入札する,
So that 希望価格で落札のチャンスを得られる
```

### US-002: 即決購入（ファン視点）
```
As a ファン,
I want to オークションを待たずに即座に購入する,
So that 確実にTalk枠を獲得できる
```

### US-003: オークション作成（インフルエンサー視点）
```
As a インフルエンサー,
I want to Talk枠をオークション形式で出品する,
So that 適正な市場価格で販売できる
```

### US-004: リアルタイム更新（ファン視点）
```
As a ファン,
I want to 最高入札額と残り時間をリアルタイムで確認する,
So that 戦略的に入札できる
```

## ビジネスルール

### BR-001: 価格設定
- **説明**: オークションの価格設定に関するルール
- **条件**: 
  - 最低入札価格: 100円以上
  - 最小入札単位: 100円（変更可能）
  - 即決価格: 開始価格より高く設定
- **結果**: 適正な価格設定により、公平な取引が実現される

### BR-002: オークション期間
- **説明**: オークションの開催期間に関するルール
- **条件**:
  - オークション終了時刻: Talk開始時刻の1時間前に自動設定
  - 最低オークション期間: 1時間（推奨）
- **結果**: 十分な入札機会を提供し、適正価格での落札を促進

### BR-003: 入札制限
- **説明**: 入札可能なユーザーと条件に関するルール
- **条件**:
  - 未ログインユーザーは入札不可
  - カード未登録ユーザーは入札不可
  - 自分が最高入札者の場合も再入札可能（上乗せ）
- **結果**: 確実に決済可能なユーザーのみが入札でき、取引の安全性が保証される

### BR-004: 決済タイミング
- **説明**: 入札時とTalk完了時の決済処理に関するルール
- **条件**:
  - 入札時: 与信確保のみ（Authorization）
  - Talk完了後: 決済確定（Capture）
  - Talk不成立: 与信解放（Cancel）
- **結果**: ファンはTalk完了後のみ課金され、不公平な決済を回避できる

### BR-005: オークション終了処理
- **説明**: オークション終了時の落札者決定に関するルール
- **条件**:
  - オークション終了時刻到達時に自動的に終了
  - 最高入札者が落札者となる
  - 入札がない場合は落札者なし
- **結果**: 公平かつ自動的に落札者が決定される

### BR-006: 落札後の処理
- **説明**: オークション落札後のTalk枠管理に関するルール
- **条件**:
  - 落札時に`purchased_slots`レコードが作成される
  - 落札できなかった入札者の与信が解放される
  - 落札者のみがTalkに参加できる
- **結果**: 落札者と非落札者が明確に区別され、適切に処理される

## 業務フロー

### オークション開催フロー
```
1. インフルエンサーがTalk枠を作成
   ↓
2. オークションが自動的に作成される（終了時刻: Talk開始時刻の1時間前）
   ↓
3. オークションが開始（status: 'active'）
   ↓
4. ファンが入札（与信確保）
   ↓
5. 最高入札額が更新される
   ↓
6. オークション終了時刻到達
   ↓
7. 最高入札者が落札者として決定
   ↓
8. purchased_slotsレコードが作成される
   ↓
9. 落札できなかった入札者の与信が解放される
```

### 即決購入フロー
```
1. インフルエンサーが即決価格を設定
   ↓
2. ファンが即決購入ボタンをクリック
   ↓
3. 与信確保
   ↓
4. オークションが即座に終了
   ↓
5. purchased_slotsレコードが作成される
   ↓
6. 他の入札者の与信が解放される
```

## 制約事項

### ビジネス上の制約
- 与信確保（Authorization）は最大7日間のみ有効（Stripe制限）
- リアルタイム更新はポーリング方式（WebSocketは未実装）
- オークション終了時刻はTalk開始時刻の1時間前に固定

### 技術的制約
- 入札額の検証はサーバーサイドで行われる
- ユーザー認証状態がすべての入札処理で検証される
- Stripe Payment Intentを使用した安全な決済処理

## 用語定義

| 用語 | 定義 |
|------|------|
| オークション | Talk枠を競売形式で販売する仕組み |
| 入札 | ファンがオークションで提示する購入希望価格 |
| 開始価格 | オークションの最低入札価格 |
| 最小入札単位 | 入札時の最小増加額（デフォルト: 100円） |
| 即決価格 | オークションを待たずに即座に購入できる価格 |
| 最高入札額 | オークションの現在の最高入札額 |
| 落札 | オークション終了時に最高入札者となり、Talk枠を獲得すること |
| 落札者 | オークションで最高入札額を提示し、Talk枠を獲得したユーザー |

## 変更履歴

| 日付 | 変更内容 | 理由 | 承認者 |
|------|----------|------|--------|
| 2025-12-10 | 初回作成 | 業務要件ドキュメントの整備 | - |
| 2025-01-XX | 業務仕様として再構成 | ドキュメント体系の整理 | - |

## 関連する業務

- [ビデオ通話業務](./video-call.md) - オークション落札後のTalk実施
- [決済業務](./payment.md) - 与信確保と決済確定
- [ユーザー管理業務](./user-management.md) - ユーザー認証とカード登録

