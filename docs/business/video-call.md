# ビデオ通話業務

## 概要

インフルエンサーとファンが1対1でビデオ通話を実施する業務。オークション落札後、予定時刻にDaily.coを使用した高品質ビデオ通話を提供します。通話の正常完了を自動判定し、公平な決済処理を実現します。

**ビジネス価値**:
- ファンは憧れのインフルエンサーと直接コミュニケーションできる
- インフルエンサーはファンとの関係を深め、収益を得られる
- プラットフォームは高品質な通話体験により信頼性を確保

## ユーザーストーリー

### US-001: Talk枠作成（インフルエンサー視点）
```
As a インフルエンサー,
I want to Talk枠（通話枠）を作成してオークションに出品する,
So that ファンとの通話で収益を得られる
```

### US-002: Talk枠一覧閲覧（ファン視点）
```
As a ファン,
I want to 開催中のTalk枠一覧を閲覧する,
So that 興味のあるインフルエンサーのTalkを見つけられる
```

### US-003: Talk予定確認（ファン視点）
```
As a ファン,
I want to 落札したTalkの予定を確認する,
So that 通話時刻を忘れずに参加できる
```

### US-004: ビデオ通話実施（ファン・インフルエンサー共通）
```
As a ユーザー（ファン/インフルエンサー）,
I want to 予定時刻に高品質なビデオ通話を実施する,
So that スムーズにコミュニケーションできる
```

### US-005: Talk完了確認（システム）
```
As a システム,
I want to Talkが正常に完了したかを自動判定する,
So that 公平な決済処理を実現できる
```

## ビジネスルール

### BR-001: Talk枠作成制限
- **説明**: Talk枠を作成できるユーザーと条件に関するルール
- **条件**:
  - インフルエンサーのみ作成可能
  - 通話開始予定時刻は未来の日時のみ
  - 通話時間は最低5分以上
- **結果**: 適正なTalk枠のみが作成され、品質が保証される

### BR-002: 通話アクセス制限
- **説明**: 通話にアクセスできるユーザーとタイミングに関するルール
- **条件**:
  - 購入済みTalk枠のみアクセス可能
  - **CallPage入室**:
    - インフルエンサー: オークション終了後いつでも入室可能（制限なし）
    - ファン: いつでも入室可能（制限なし）
  - **Daily.co接続**:
    - インフルエンサー: 予定時刻の15分前から接続可能
    - ファン: 予定時刻から接続可能（自動接続）
  - 両者とも予定時刻の30分後までDaily.co接続可能
  - 通話ステータスが`completed`の場合は再アクセス不可
- **結果**: 適切なユーザーが適切なタイミングで通話に参加できる

### BR-003: 時刻表示
- **説明**: 時刻の表示方法に関するルール
- **条件**:
  - すべて日本時間（Asia/Tokyo）で表示
  - フォーマット: `YYYY/MM/DD HH:MM`
- **結果**: ユーザーが時刻を正確に理解できる

### BR-004: Talk完了判定
- **説明**: Talkが正常に完了したかを判定するルール
- **条件**:
  - インフルエンサー参加必須
  - 規定時間経過による自動終了必須
  - 途中退出なし必須（開始時刻から終了時刻まで連続参加）
- **結果**: 公平な決済判定が実現される

### BR-005: 決済タイミング
- **説明**: Talk完了後の決済処理に関するルール
- **条件**:
  - Talk正常完了: 決済確定（Capture）
  - Talk不成立: 与信解放（Cancel）
  - インフルエンサーno-show: 与信解放（Cancel）
- **結果**: ファンは正常完了時のみ課金され、不公平な決済を回避できる

### BR-006: 通話ステータス管理
- **説明**: 通話枠のステータス遷移に関するルール
- **条件**:
  - 作成時: `planned`（予定済み）
  - オークション落札時: `live`（実施中）
  - 通話完了時: `completed`（完了）
  - キャンセル時: `cancelled`（キャンセル、将来実装）
- **結果**: 通話枠の状態が正確に追跡され、適切な処理が実行される

### BR-007: 途中退室の扱い
- **説明**: 通話中の途中退室に関するルール
- **条件**:
  - インフルエンサー途中退室: ファンへの課金はキャンセル
  - ファン途中退室: 課金は確定（キャンセルされない）
  - 時間切れ（残り時間0）: 警告なしで終了
- **結果**: 公平な課金ルールが適用される

### BR-008: 待機室での入室状態表示ルール
- **説明**: 待機室（CallPage）では、各参加者の実際の入室状態を表示する
- **表示ルール**:
  - 自分がCallPage入室、相手が未入室 → 自分: 待機中、相手: 未入室
  - 両者がCallPage入室 → 両者: 待機中
  - 両者がDaily.co接続中 → 両者: 通話中
- **結果**: ユーザーが相手の入室状態を正確に把握できる

### BR-009: インフルエンサーの入室タイミング
- **説明**: インフルエンサーは通話準備のため、オークション終了後いつでもCallPageに入室でき、開始時刻より前からDaily.coに接続できる
- **条件**:
  - CallPage入室: オークション終了後いつでも可能（制限なし）
  - Daily.co接続: 開始時刻の15分前から可能（手動で通話開始）
  - 終了: 開始時刻の30分後まで
- **結果**: インフルエンサーはオークション終了後すぐにCallPageで準備でき、余裕を持って通話準備ができ、スムーズに通話を開始できる

### BR-010: ファンの入室タイミング
- **説明**: ファンは待機画面を見ることができ、開始時刻に自動接続される
- **条件**:
  - CallPage入室: いつでも可能（開始前は待機画面を表示）
  - Daily.co接続: 開始時刻になったら自動的に接続
  - 終了: 開始時刻の30分後まで
- **結果**: ファンは待機画面で準備でき、開始時刻に自動的に通話が開始される

## 業務フロー

### Talk実施フロー
```
1. オークション落札（purchased_slots作成）
   ↓
2. call_slots.status が 'live' に更新
   ↓
3. 通話予定時刻の前後30分にアクセス可能
   ↓
4. インフルエンサー・ファンが通話ルームに入室
   ↓
5. 通話開始（call_status: 'in_progress'）
   ↓
6. 規定時間経過で自動終了、または手動終了
   ↓
7. Talk完了判定（インフルエンサー参加・時間経過・途中退出なし）
   ↓
8. 正常完了の場合: 決済確定
   不成立の場合: 与信解放
   ↓
9. call_slots.status が 'completed' に更新
```

### ステータス遷移フロー
```
planned（作成時）
   ↓
live（オークション落札時）
   ↓
completed（通話完了時）
   ↓
cancelled（キャンセル時、将来実装）
```

## 制約事項

### ビジネス上の制約
- インフルエンサーはオークション終了後いつでもCallPageに入室可能、Daily.co接続は開始時刻の15分前から可能（BR-009参照）
- ファンはいつでもCallPageに入室可能、Daily.co接続は開始時刻から可能（BR-010参照）
- 両者とも開始時刻の30分後までDaily.co接続可能
- Daily.co無料プランは通話時間に制限あり

### 技術的制約
- ビデオ通話はWebRTC対応ブラウザのみ（IE非対応）
- Daily.coルームURLは推測不可能なランダム文字列
- Webhook受信時にHMAC署名を検証する

## 用語定義

| 用語 | 定義 |
|------|------|
| Talk枠 | インフルエンサーが提供する通話枠 |
| Talk | インフルエンサーとファンの1対1ビデオ通話 |
| 通話開始予定時刻 | Talkが開始される予定の日時 |
| 通話時間 | Talkの予定時間（分単位、デフォルト: 30分） |
| 通話ステータス | Talkの進行状態（upcoming/ready/in_progress/completed/cancelled） |
| インフルエンサーno-show | インフルエンサーが予定時刻になっても通話ルームに参加しないこと |
| 途中退出 | 規定時間（開始時刻から終了時刻まで）の間に通話から退出すること |
| 待機中 | CallPageに入室しているが、Daily.coセッションには未入室 |
| 参加済み | Daily.coセッションに入室済み（実際の通話中） |
| 未入室 | CallPageにも入室していない |
| 通話中 | 両者がDaily.coセッションに接続中 |

## 変更履歴

| 日付 | 変更内容 | 理由 | 承認者 |
|------|----------|------|--------|
| 2025-12-10 | 初回作成 | 業務要件ドキュメントの整備 | - |
| 2025-01-XX | 業務仕様として再構成、通話ステータス管理を統合 | ドキュメント体系の整理 | - |
| 2025-01-XX | BR-008, BR-009, BR-010を追加、BR-002を更新 | Issue #1, #2対応のための入室状態表示と入室タイミングルールを明確化 | - |
| 2026-01-02 | BR-002, BR-009を更新 | インフルエンサーのCallPage入室をオークション終了後いつでも可能に変更 | - |

## 関連する業務

- [オークション業務](./auction.md) - Talk枠のオークション出品
- [決済業務](./payment.md) - Talk完了後の決済確定
- [ユーザー管理業務](./user-management.md) - Talk枠作成フォーム

